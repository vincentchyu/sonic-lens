<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>音眸轨迹</title>
    <link rel="icon" type="image/svg+xml" href="../static/logo.svg" media="(prefers-color-scheme: light)"/>
    <link rel="icon" type="image/svg+xml" href="../static/logo_black.svg" media="(prefers-color-scheme: dark)"/>
    <script src="../static/chart.js"></script>
    <script src="../static/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="../static/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --background-color: #f0f2f5;
            --accent-color: #e74c3c;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --card-bg: rgba(255, 255, 255, 0.45);
            --glass-border: rgba(255, 255, 255, 0.6);
            --border-color: rgba(255, 255, 255, 0.4);
            /* 播放渠道颜色 */
            --source-applemusic: #e74c3c;
            --source-audirvana: #9b59b6;
            --source-roon: #7f8c8d;
        }

        /* AI Insight Tabs */
        .insight-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 15px;
            overflow-x: auto;
            gap: 10px;
            background-color: var(--card-bg);
            padding: 10px 0;
        }

        .insight-tab {
            padding: 8px 16px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            font-size: 0.9rem;
            white-space: nowrap;
            transition: all 0.2s ease;
            border-radius: 6px 6px 0 0;
        }

        .insight-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 600;
            background-color: rgba(52, 152, 219, 0.08);
        }

        .insight-tab:hover {
            color: var(--primary-color);
            background-color: rgba(52, 152, 219, 0.05);
        }

        /* AI 模型选择器样式 */
        .ai-model-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 5px 10px;
        }

        .ai-model-selector label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: 600;
            white-space: nowrap;
        }

        .ai-model-selector select {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 0.85rem;
            outline: none;
            cursor: pointer;
            padding: 2px 0;
        }

        .dark-mode .ai-model-selector select option {
            background-color: var(--card-bg);
        }

        .dark-mode {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --primary-color: #8da2fb;
            --secondary-color: #a37ee1;
            --background-color: #0f1114;
            --accent-color: #ff6b6b;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --card-bg: rgba(20, 22, 28, 0.35);
            --glass-border: rgba(255, 255, 255, 0.12); /* 暗色毛玻璃边缘 */
            --border-color: rgba(45, 55, 72, 0.4);
            /* 播放渠道颜色 */
            --source-applemusic: #ff6b6b;
            --source-audirvana: #c084fc;
            --source-roon: #94a3b8;
        }

        /* Watermark Logo */
        .watermark {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 150px;
            height: 50px;
            background-image: url('../static/logo_all.svg');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: left bottom;
            opacity: 0.15;
            z-index: 9999;
            pointer-events: none;
            transition: background-image 0.3s ease;
        }

        .dark-mode .watermark {
            background-image: url('../static/logo_all_black.svg');
            opacity: 0.15;
        }

        /* 全局毛玻璃组件统一样式 */
        .navbar, .stat-card, .chart-card, .ranking-card, #nowPlaying, .ai-model-selector, .modal-content, #lyricsFloating, .insight-tabs, #recentTracksModal {
            backdrop-filter: blur(24px) saturate(150%);
            -webkit-backdrop-filter: blur(24px) saturate(150%);
            background-color: var(--card-bg) !important;
            border: 1px solid var(--glass-border) !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
            background-color: transparent;
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* 高级动态流光背景 (Ambient Aurora Glassmorphism) */
        .ambient-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
            overflow: hidden;
            pointer-events: none;
            background-color: var(--background-color);
            transition: background-color 0.3s ease;
        }

        .color-orb {
            position: absolute;
            filter: blur(120px);
            opacity: 0.6;
            border-radius: 50%;
            animation: float-orb 20s infinite ease-in-out alternate;
            transform: translateZ(0); /* 开启 GPU 硬件加速 */
            will-change: transform;
        }

        .orb-1 {
            width: 70vw;
            height: 70vw;
            background: rgba(102, 126, 234, 0.35); /* 蓝 */
            top: -20vh;
            left: -10vw;
            animation-delay: 0s;
            animation-duration: 25s;
        }

        .orb-2 {
            width: 60vw;
            height: 60vw;
            background: rgba(118, 75, 162, 0.3); /* 紫 */
            bottom: -20vh;
            right: -10vw;
            animation-delay: -5s;
            animation-duration: 30s;
        }

        .orb-3 {
            width: 50vw;
            height: 50vw;
            background: rgba(142, 162, 250, 0.25); /* 浅紫/高亮 */
            top: 30vh;
            left: 40vw;
            animation-delay: -10s;
            animation-duration: 35s;
        }

        .dark-mode .orb-1 {
            background: rgba(102, 126, 234, 0.18);
        }

        .dark-mode .orb-2 {
            background: rgba(118, 75, 162, 0.15);
        }

        .dark-mode .orb-3 {
            background: rgba(82, 102, 200, 0.12);
        }

        @keyframes float-orb {
            0% {
                transform: translate(0, 0) scale(1);
            }
            33% {
                transform: translate(6vw, 8vh) scale(1.1);
            }
            66% {
                transform: translate(-8vw, 12vh) scale(0.9);
            }
            100% {
                transform: translate(12vw, -6vh) scale(1.05);
            }
        }


        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* 悬浮侧边栏导航 */
        .navbar {
            position: fixed;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            height: auto;
            padding: 20px 10px;
            border-radius: 0 16px 16px 0;
            z-index: 2000;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 200px;
            border-right: 1px solid var(--glass-border);
        }

        /* 收起状态 */
        .navbar.collapsed {
            width: 80px;
            transform: translateY(-50%) translateX(-60px); /* 只露出一小截或靠边 */
        }

        .navbar.collapsed:hover {
            transform: translateY(-50%) translateX(0);
        }

        /* 切换按钮 */
        .nav-toggle {
            position: absolute;
            right: -12px;
            top: 20px;
            width: 24px;
            height: 24px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            z-index: 2001;
            transition: all 0.3s ease;
            font-size: 12px;
            border: 2px solid var(--glass-border);
        }

        .navbar.collapsed .nav-toggle {
            transform: rotate(180deg);
            right: 5px;
        }

        .navbar-content {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            width: 100%;
            height: 100%;
        }

        .logo {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-color);
            text-decoration: none;
            margin-bottom: 30px;
            text-transform: uppercase;
            letter-spacing: 2px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .logo-icon {
            font-size: 1.8rem;
        }

        .logo-text {
            opacity: 1;
            font-size: 1rem;
            transition: opacity 0.3s ease;
            display: block;
        }

        .navbar.collapsed .logo-text {
            opacity: 0;
            display: none;
        }

        .nav-links {
            display: flex;
            flex-direction: column;
            list-style: none;
            width: 100%;
            gap: 15px;
        }

        .nav-links li {
            margin-left: 0;
            width: 100%;
        }

        .nav-links a {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            text-decoration: none;
            color: var(--text-primary);
            font-weight: 500;
            padding: 12px 10px;
            padding-left: 20px;
            border-radius: 8px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .navbar.collapsed .nav-links a {
            justify-content: center;
            padding-left: 10px;
        }

        .nav-text {
            margin-left: 10px;
            opacity: 1;
            white-space: nowrap;
            transform: translateX(0);
            transition: all 0.3s ease;
            display: inline-block;
        }

        .navbar.collapsed .nav-text {
            opacity: 0;
            transform: translateX(-10px);
            display: none;
        }

        .nav-links a:hover,
        .nav-links a.active {
            background-color: rgba(102, 126, 234, 0.15);
            color: var(--primary-color);
        }

        .nav-links a.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 20%;
            height: 60%;
            width: 4px;
            background-color: var(--primary-color);
            border-radius: 0 4px 4px 0;
        }

        /* 调整主容器边距，避免被侧边栏遮挡 */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            margin-left: 220px; /* 默认展开时的左边距 */
            transition: margin-left 0.4s ease;
        }

        .navbar.collapsed ~ .container {
            margin-left: 100px;
        }

        @media (max-width: 1200px) {
            .container {
                margin-left: 80px; /* 较小屏幕下减少边距 */
            }
            .navbar {
                width: 80px;
                transform: translateY(-50%) translateX(-60px);
            }
            .navbar.collapsed {
                transform: translateY(-50%) translateX(-60px);
            }
            .navbar .logo-text, .navbar .nav-text {
                display: none;
            }
            .navbar:hover {
                width: 200px;
                transform: translateY(-50%) translateX(0);
            }
            .navbar:hover .logo-text, .navbar:hover .nav-text {
                display: inline-block;
                opacity: 1;
            }
            .nav-toggle {
                display: none; /* 移动端或窄屏隐藏切换按钮 */
            }
        }

        /* 统计卡片 */
        .stats-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            padding: 15px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            min-width: 150px;
            flex: 1;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .stat-title {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .stat-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .icon-1 {
            background-color: rgba(52, 152, 219, 0.1);
            color: var(--primary-color);
        }

        .icon-2 {
            background-color: rgba(46, 204, 113, 0.1);
            color: var(--secondary-color);
        }

        .icon-3 {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--accent-color);
        }

        .icon-4 {
            background-color: rgba(155, 89, 182, 0.1);
            color: #9b59b6;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 3px;
        }

        .stat-change {
            font-size: 0.8rem;
            font-weight: 500;
        }

        .positive {
            color: var(--secondary-color);
        }

        .negative {
            color: var(--accent-color);
        }

        /* AI 加载动画样式 */
        .ai-loading-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .ai-ripple {
            display: inline-block;
            position: relative;
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
        }

        .ai-ripple div {
            position: absolute;
            border: 4px solid var(--primary-color);
            opacity: 1;
            border-radius: 50%;
            animation: ai-ripple 1.5s cubic-bezier(0, 0.2, 0.8, 1) infinite;
        }

        .ai-ripple div:nth-child(2) {
            animation-delay: -0.5s;
        }

        @keyframes ai-ripple {
            0% {
                top: 36px;
                left: 36px;
                width: 0;
                height: 0;
                opacity: 0;
            }
            4.9% {
                top: 36px;
                left: 36px;
                width: 0;
                height: 0;
                opacity: 0;
            }
            5% {
                top: 36px;
                left: 36px;
                width: 0;
                height: 0;
                opacity: 1;
            }
            100% {
                top: 0px;
                left: 0px;
                width: 72px;
                height: 72px;
                opacity: 0;
            }
        }

        .ai-loading-text {
            font-size: 1rem;
            font-weight: 500;
            letter-spacing: 1px;
            background: linear-gradient(90deg, var(--text-secondary), var(--primary-color), var(--text-secondary));
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shine 3s linear infinite;
        }

        @keyframes shine {
            to {
                background-position: 200% center;
            }
        }

        /* 图表区域 */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 25px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .time-filters {
            display: flex;
            background-color: #f1f3f9;
            border-radius: 8px;
            padding: 4px;
        }

        .dark-mode .time-filters {
            background-color: #3a3a3a; /* 夜间模式下的背景色 */
        }

        .time-filter {
            padding: 6px 12px;
            font-size: 0.9rem;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
            background-color: #f1f3f9;
            color: #2c3e50;
            border: 1px solid #e9ecef;
        }

        .dark-mode .time-filter {
            background-color: #3a3a3a;
            color: var(--text-secondary);
            border: 1px solid #444444;
        }

        .time-filter.active {
            background-color: var(--primary-color);
            color: white;
            border: 1px solid var(--primary-color);
        }

        .dark-mode .time-filter.active {
            background-color: var(--primary-color);
            color: white;
            border: 1px solid var(--primary-color);
        }

        .time-filter:disabled {
            background-color: #e9ecef;
            color: #7f8c8d;
            cursor: not-allowed;
        }

        .dark-mode .time-filter:disabled {
            background-color: #444444;
            color: #7f8c8d;
            border: 1px solid #555555;
        }

        .chart-container {
            height: 300px;
            position: relative;
        }

        /* 排行榜容器 */
        .rankings-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        /* 排行榜 */
        .ranking-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 25px;
            margin-bottom: 0;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .ranking-list {
            list-style: none;
            flex-grow: 1;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .ranking-item:last-child {
            border-bottom: none;
        }

        .rank-number {
            width: 36px;
            height: 36px;
            flex-shrink: 0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 15px;
        }

        .rank-1 {
            background-color: #ffd700;
            color: #333;
        }

        .rank-2 {
            background-color: #c0c0c0;
            color: #333;
        }

        .rank-3 {
            background-color: #cd7f32;
            color: #fff;
        }

        .rank-other {
            background-color: var(--primary-color);
            color: white;
        }

        .track-info {
            flex: 1;
            min-width: 0; /* Ensures flex child can shrink below its minimum content size */
            margin-right: 15px;
        }

        .track-title {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .track-artist {
            font-size: 0.8rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .track-album {
            font-size: 0.8rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .play-count {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        /* 播放渠道样式 */
        .play-source {
            font-size: 0.8rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
            margin-bottom: 4px;
            align-self: flex-end;
            display: inline-block;
            width: auto;
            flex-shrink: 0;
            white-space: nowrap;
        }

        .source-applemusic {
            color: var(--source-applemusic);
            background-color: rgba(231, 76, 60, 0.1);
        }

        .source-audirvana {
            color: var(--source-audirvana);
            background-color: rgba(155, 89, 182, 0.1);
        }

        .source-roon {
            color: var(--source-roon);
            background-color: rgba(127, 140, 141, 0.1);
        }

        /* 模块及弹窗轨迹背景 */
        .stat-card, .chart-card, .ranking-card, .modal-content, #nowPlaying, #lyricsFloating {
            position: relative;
            overflow: hidden;
        }

        .stat-card *:not(.module-trail), .chart-card *:not(.module-trail), .ranking-card *:not(.module-trail),
        .modal-content *:not(.module-trail), #nowPlaying *:not(.module-trail), #lyricsFloating *:not(.module-trail) {
            position: relative;
            z-index: 1;
        }

        .module-trail {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 0;
            opacity: 0.12;
            /* 蓝紫渐变风格的轨迹纹理 */
            background-image: url("data:image/svg+xml,%3Csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23667eea;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23764ba2;stop-opacity:1' /%3E%3C/linearGradient%3E%3Cpath id='trail1' d='M-100,50 Q150,150 400,50 T900,150' /%3E%3C/defs%3E%3Cuse href='%23trail1' fill='none' stroke='url(%23grad)' stroke-width='1.5' stroke-dasharray='12,12' opacity='0.5' /%3E%3Ctext font-size='11' fill='url(%23grad)' opacity='0.3'%3E%3CtextPath href='%23trail1' startOffset='25%25'%3E轨迹 轨迹%3C/textPath%3E%3C/text%3E%3C/svg%3E");
            background-size: cover;
        }

        .dark-mode .module-trail {
            opacity: 0.2;
            filter: saturate(1.2) brightness(1.2);
        }

        .stat-card:hover, .chart-card:hover, .ranking-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.12);
            transform: translateY(-2px);
        }

        /* 响应式设计 */
        @media (max-width: 1200px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            /* 在手机端恢复底部导航或顶部导航，侧滑体验在手机上较差 */
            .navbar {
                position: fixed;
                bottom: 0;
                left: 0;
                top: auto;
                transform: none;
                width: 100%;
                height: auto;
                flex-direction: row;
                border-radius: 16px 16px 0 0;
                padding: 10px;
                border-right: none;
                border-top: 1px solid var(--glass-border);
            }

            .navbar:hover {
                transform: none;
                width: 100%;
            }

            .navbar-content {
                flex-direction: row;
                justify-content: space-around;
            }

            .logo {
                display: none; /* 手机端导航底栏隐藏 Logo */
            }

            .nav-links {
                flex-direction: row;
                justify-content: space-around;
                margin-top: 0;
                gap: 0;
            }

            .nav-links li {
                margin: 0;
            }

            .nav-links a {
                flex-direction: column;
                padding: 5px 10px;
                border-radius: 8px;
            }

            .nav-text {
                display: block;
                opacity: 1;
                transform: none;
                font-size: 0.7rem;
                margin-left: 0;
                margin-top: 3px;
            }

            .navbar:hover .nav-links a {
                padding-left: 10px;
                justify-content: center;
            }

            .nav-links a.active::before {
                display: none;
            }

            /* 给容器加底边距，防止被底部导航遮挡 */
            .container {
                padding-bottom: 80px;
            }

            .stats-container {
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            }

            .ranking-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .track-info {
                margin: 10px 0;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-value {
                font-size: 1.8rem;
            }

            .charts-container {
                gap: 15px;
            }

            .chart-card {
                padding: 15px;
            }

            .card-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .time-filters {
                margin-top: 10px;
                align-self: flex-start;
            }

            .ranking-item {
                padding: 10px 0;
            }

            .track-title {
                font-size: 1rem;
            }

            .track-artist {
                font-size: 0.9rem;
            }
        }

        /* 超小屏幕优化 */
        @media (max-width: 320px) {
            .stat-card {
                padding: 10px;
            }

            .stat-title {
                font-size: 0.9rem;
            }

            .stat-value {
                font-size: 1.5rem;
            }

            .chart-card {
                padding: 10px;
            }
        }

        /* 全屏按钮简约样式 */
        .fullscreen-btn {
            background-color: transparent;
            border: 1px solid #d1d1d1;
            border-radius: 4px;
            color: #666;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .dark-mode .fullscreen-btn {
            border: 1px solid #555; /* 夜间模式下的边框颜色 */
            color: var(--text-secondary);
        }

        .fullscreen-btn:hover {
            background-color: #f0f0f0;
            border-color: #a0a0a0;
            color: #333;
        }

        .dark-mode .fullscreen-btn:hover {
            background-color: #444; /* 夜间模式下的悬停背景色 */
            border-color: #777; /* 夜间模式下的悬停边框颜色 */
            color: var(--text-primary);
        }

        /* 实时播放信息悬浮窗 */
        #nowPlaying {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 240px;
            background-color: rgba(255, 255, 255, 0.95); /* 90% 不透明度 */
            border: 1px solid var(--border-color);
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            padding: 20px;
            z-index: 1000;
            display: none;
            animation: fadeIn 0.3s ease;
            cursor: move;
            user-select: none;
        }

        /* 夜间模式下的正在播放悬浮窗 */
        .dark-mode #nowPlaying {
            background-color: rgba(44, 44, 44, 0.95); /* 暗色背景 */
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #nowPlaying h3 {
            margin-top: 0;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            font-size: 1.2rem;
        }

        .dark-mode #nowPlaying h3 {
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
        }

        /* 调整悬浮窗内容区域的最小高度 */
        #nowPlayingInfo {
            min-height: 100px;
        }

        .dark-mode #nowPlayingInfo {
            min-height: 100px;
        }

        /* 正在播放操作按钮区域 */
        .now-playing-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }

        .action-btns-group {
            display: flex;
            gap: 6px;
        }

        .action-btn {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 3px 10px;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .action-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        }

        .sse-toggle-compact {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.7rem;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .sse-toggle-compact input {
            cursor: pointer;
            width: 12px;
            height: 12px;
        }

        /* 喜欢状态指示器容器 */
        .favorite-indicators-container {
            font-size: 0.75rem;
            margin-top: 8px;
            text-align: right;
            color: var(--text-secondary);
        }

        /* 喜欢状态指示器 */
        .favorite-indicator {
            display: inline-block;
            margin-left: 0;
            vertical-align: middle;
            font-size: 0.8em;
            color: var(--text-secondary);
        }

        .dark-mode .favorite-indicator {
            color: var(--text-secondary);
        }

        /* 收藏按钮样式调整 */
        .favorite-button {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            transition: transform 0.2s ease, color 0.2s ease;
            margin-top: 10px;
            padding: 0;
            width: auto;
            height: auto;
        }

        .dark-mode .favorite-button {
            background: none;
            border: none;
        }

        .favorite-button:hover {
            transform: scale(1.1);
        }

        .dark-mode .favorite-button:hover {
            transform: scale(1.1);
        }

        .favorite-button.liked {
            color: var(--source-applemusic);
            cursor: not-allowed; /* 已收藏时禁用点击 */
        }

        .dark-mode .favorite-button.liked {
            color: var(--source-applemusic);
            cursor: not-allowed; /* 已收藏时禁用点击 */
        }

        .favorite-button.unliked {
            color: #ccc;
        }

        .dark-mode .favorite-button.unliked {
            color: #888; /* 夜间模式下使用较暗的灰色 */
        }

        /* 歌曲标题和收藏按钮容器 */
        .track-title-favorite-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .dark-mode .track-title-favorite-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        /* 确保歌曲标题在容器中正确显示 */
        .track-title {
            flex-grow: 1; /* 允许标题占据可用空间 */
            white-space: nowrap; /* 防止标题换行 */
            overflow: hidden; /* 隐藏超出部分 */
            text-overflow: ellipsis; /* 超出部分显示省略号 */
        }

        .dark-mode .track-title {
            color: var(--text-primary); /* 夜间模式下使用主文本颜色 */
        }

        /* 正在播放悬浮窗头部 */
        .now-playing-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: -20px -20px 15px -20px;
            padding: 8px 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: move;
        }

        .dark-mode .now-playing-header {
            border-bottom: 1px solid var(--border-color);
        }

        /* 正在播放控制按钮 */
        .now-playing-controls {
            display: flex;
            gap: 5px;
        }

        .dark-mode .now-playing-controls {
            display: flex;
            gap: 5px;
        }

        /* 拖动把手 */
        .drag-handle {
            cursor: move;
            font-size: 1.2rem;
            color: #95a5a6;
            padding: 0 3px;
        }

        .dark-mode .drag-handle {
            color: #bdc3c7; /* 夜间模式下使用较亮的颜色 */
        }

        /* 缩小把手 */
        .minimize-handle {
            cursor: pointer;
            font-size: 1.2rem;
            color: #95a5a6;
            padding: 0 3px;
            font-weight: bold;
        }

        .dark-mode .minimize-handle {
            color: #bdc3c7; /* 夜间模式下使用较亮的颜色 */
        }

        /* 拖动时的样式 */
        #nowPlaying.dragging {
            opacity: 0.8;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
        }

        .dark-mode #nowPlaying.dragging {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
        }

        /* 缩小状态的样式 */
        #nowPlaying.minimized {
            width: 150px;
            height: 60px;
            padding: 10px;
        }

        .dark-mode #nowPlaying.minimized {
            width: 150px;
            height: 60px;
            padding: 10px;
        }

        #nowPlaying.minimized .now-playing-header {
            margin: -10px -10px 10px -10px;
            padding: 5px 10px;
        }

        .dark-mode #nowPlaying.minimized .now-playing-header {
            margin: -10px -10px 10px -10px;
            padding: 5px 10px;
        }

        #nowPlaying.minimized #nowPlayingInfo {
            display: none;
        }

        .dark-mode #nowPlaying.minimized #nowPlayingInfo {
            display: none;
        }

        #nowPlaying.minimized h3 {
            font-size: 1rem;
            padding-bottom: 0;
            border-bottom: none;
            margin-bottom: 0;
        }

        .dark-mode #nowPlaying.minimized h3 {
            font-size: 1rem;
            padding-bottom: 0;
            border-bottom: none;
            margin-bottom: 0;
        }

        /* 未上报记录容器 */
        .dark-mode #unscrobbledContainer .chart-card {
            background-color: var(--card-bg);
            color: var(--text-primary);
        }

        .dark-mode #unscrobbledContainer .card-title {
            color: var(--text-primary);
        }

        .dark-mode #unscrobbledContainer .loading {
            color: var(--text-secondary);
        }

        /* 未上报记录表格 */
        .dark-mode #unscrobbledContainer table {
            color: var(--text-primary);
        }

        .dark-mode #unscrobbledContainer table thead tr {
            background-color: #3a3a3a;
        }

        .dark-mode #unscrobbledContainer table thead th {
            border-bottom: 2px solid #444444;
        }

        .dark-mode #unscrobbledContainer table tbody tr {
            border-bottom: 1px solid #444444;
        }

        /* 未上报记录分页 */
        .dark-mode #unscrobbledContainer #pagination {
            color: var(--text-primary);
        }

        /* 喜欢状态指示器 */
        .favorite-indicator {
            display: inline-block;
            margin-left: 10px;
            vertical-align: middle;
            font-size: 0.8em;
            color: var(--text-secondary);
        }

        /* 点赞按钮 */
        .favorite-button {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            transition: transform 0.2s ease, color 0.2s ease;
            margin-top: 10px;
            padding: 0;
            width: auto;
            height: auto;
        }

        .dark-mode .favorite-button {
            background: none;
            border: none;
        }

        .favorite-button:hover {
            transform: scale(1.1);
        }

        .favorite-button.liked {
            color: var(--source-applemusic);
            cursor: not-allowed; /* 已收藏时禁用点击 */
        }

        .favorite-button.unliked {
            color: #ccc;
        }

        /* 播放进度条容器 */
        .progress-container {
            width: 100%;
            margin: 15px 0 10px 0;
            position: relative;
        }

        .dark-mode .progress-container {
            width: 100%;
            margin: 15px 0 10px 0;
        }

        /* 进度条轨道 */
        .progress-track {
            width: 100%;
            height: 6px;
            background-color: #e9ecef;
            border-radius: 3px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .dark-mode .progress-track {
            background-color: #555; /* 夜间模式下使用较暗的背景 */
        }

        /* 进度条已完成部分 */
        .progress-fill {
            height: 100%;
            background-color: var(--primary-color);
            border-radius: 3px;
            width: 0%;
            transition: width 0.3s ease;
        }

        .dark-mode .progress-fill {
            background-color: var(--primary-color);
        }

        /* 进度条拖拽点 */
        .progress-thumb {
            position: absolute;
            top: 50%;
            right: 0;
            transform: translate(50%, -50%);
            width: 12px;
            height: 12px;
            background-color: var(--primary-color);
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
        }

        .dark-mode .progress-thumb {
            background-color: var(--primary-color);
        }

        .progress-track:hover .progress-thumb {
            opacity: 1;
        }

        .dark-mode .progress-track:hover .progress-thumb {
            opacity: 1;
        }

        /* 播放进度时间显示 */
        .progress-time {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .dark-mode .progress-time {
            color: var(--text-secondary);
        }

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: var(--card-bg);
            margin: 5% auto;
            padding: 0;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
            animation-name: animatetop;
            animation-duration: 0.3s;
        }

        /* 歌曲详情模态框：标题和Tab固定，仅内容区滚动 */
        #trackDetailsModal .modal-content {
            display: flex;
            flex-direction: column;
            max-height: 85vh;
        }

        #trackDetailsModal .modal-header {
            flex-shrink: 0;
        }

        #trackDetailsModal .modal-tabs {
            flex-shrink: 0;
            position: relative;
            z-index: 10;
            background: var(--card-bg);
        }

        #trackDetailsModal .modal-body {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
            padding: 0 20px 20px 20px; /* Top padding moved to specific elements or handled by sticky margin */
        }

        /* AI分析二级Tab在内容区内吸顶 */
        #trackDetailsModal .modal-body .insight-tabs {
            position: sticky;
            top: 0;
            z-index: 5;
            background: var(--card-bg);
            margin: 0 -20px 15px -20px;
            padding: 10px 20px;
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        /* 修复第一个 section 与吸顶 Tab 的间距 */
        #trackDetailsModal .modal-body .insight-item {
            padding-top: 5px;
        }

        /* 基础信息 Tab 依然需要顶部间距 */
        #trackDetailsModal .modal-body .track-info {
            padding-top: 20px;
        }

        @keyframes animatetop {
            from {
                top: -300px;
                opacity: 0
            }
            to {
                top: 0;
                opacity: 1
            }
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            color: var(--text-primary);
        }

        /* AI 歌词解析专项样式 */
        .insight-container {
            line-height: 1.6;
            color: var(--text-primary);
        }

        .insight-section {
            margin-bottom: 24px;
            background: var(--card-bg);
            border-radius: 8px;
            padding: 16px;
            border: 1px solid var(--border-color);
        }

        .insight-section h3 {
            color: var(--primary-color);
            font-size: 1.1rem;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .lyrics-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }

        .lyrics-line {
            padding: 8px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }

        .lyrics-line:hover {
            background-color: rgba(52, 152, 219, 0.05);
        }

        .lyrics-original {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-style: italic;
        }

        .lyrics-translated {
            color: var(--primary-color);
            font-weight: 500;
            margin-top: 2px;
        }

        .analysis-text {
            white-space: pre-wrap;
            color: var(--text-primary);
            word-break: break-word;
        }

        .section-item {
            margin-bottom: 12px;
            padding-left: 12px;
            border-left: 3px solid var(--primary-color);
        }

        .section-name {
            font-weight: 700;
            color: var(--text-primary);
            display: block;
            margin-bottom: 4px;
        }

        .section-content {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .appreciate-item {
            border-left: 3px solid var(--primary-color);
        }

        .appreciate-item .section-name {
            font-weight: 700;
            color: var(--primary-color);
        }

        .appreciate-content {
            margin-top: 8px;
        }

        .explain-block {
            margin: 12px 0;
            padding: 12px 14px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%);
            border-radius: 8px;
            border-left: 3px solid var(--primary-color);
        }

        .dark-mode .explain-block {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
        }

        .explain-content {
            color: var(--text-primary);
            font-size: 0.95rem;
            line-height: 1.7;
            font-weight: 500;
            white-space: pre-wrap;
        }

        .close {
            color: var(--text-secondary);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: var(--text-primary);
        }

        /* Tab 样式 */
        .modal-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            background: rgba(0, 0, 0, 0.02);
            padding: 0 20px;
        }

        .modal-tab {
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .modal-tab:hover {
            color: var(--primary-color);
            background: rgba(52, 152, 219, 0.05);
        }

        .modal-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: transparent;
        }

        .modal-body {
            padding: 20px;
            color: var(--text-primary);
        }

        .modal-body .track-info p {
            margin: 10px 0;
        }

        .modal-body .track-info strong {
            color: var(--primary-color);
        }

        /* 歌词悬浮窗 */
        #lyricsFloating {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 380px;
            max-height: 500px;
            background-color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            padding: 20px;
            z-index: 999;
            display: none;
            animation: fadeIn 0.3s ease;
            cursor: move;
            user-select: none;
        }

        .dark-mode #lyricsFloating {
            background-color: rgba(44, 44, 44, 0.85);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        /* 歌词窗口头部 */
        .lyrics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: -20px -20px 15px -20px;
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: move;
        }

        .dark-mode .lyrics-header {
            border-bottom: 1px solid var(--border-color);
        }

        .lyrics-header h4 {
            margin: 0;
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .lyrics-controls {
            display: flex;
            gap: 8px;
        }

        .lyrics-close-btn {
            background: none;
            border: none;
            font-size: 1.3rem;
            color: #95a5a6;
            cursor: pointer;
            padding: 0 5px;
            transition: color 0.2s ease;
        }

        .lyrics-close-btn:hover {
            color: var(--accent-color);
        }

        .dark-mode .lyrics-close-btn {
            color: #bdc3c7;
        }

        .dark-mode .lyrics-close-btn:hover {
            color: var(--accent-color);
        }

        /* 歌词滚动容器 */
        .lyrics-container {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px 5px;
            line-height: 2;
        }

        .lyrics-container::-webkit-scrollbar {
            width: 6px;
        }

        .lyrics-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 3px;
        }

        .lyrics-container::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }

        .dark-mode .lyrics-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .dark-mode .lyrics-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
        }

        /* 歌词行样式 */
        .lyrics-line {
            padding: 8px 10px;
            margin: 4px 0;
            border-radius: 6px;
            transition: all 0.3s ease;
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .lyrics-line.active {
            background-color: rgba(52, 152, 219, 0.15);
            color: var(--text-primary);
            font-weight: 600;
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2);
        }

        .dark-mode .lyrics-line.active {
            background-color: rgba(93, 173, 226, 0.25);
            box-shadow: 0 2px 8px rgba(93, 173, 226, 0.3);
        }

        /* 普通文本歌词样式 */
        .lyrics-text {
            white-space: pre-wrap;
            word-wrap: break-word;
            color: var(--text-primary);
            font-size: 0.95rem;
            line-height: 1.8;
        }

        .dark-mode .lyrics-text {
            color: var(--text-primary);
        }

        /* 拖动时的样式 */
        #lyricsFloating.dragging {
            opacity: 0.8;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
        }

        .dark-mode #lyricsFloating.dragging {
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            #lyricsFloating {
                width: 90%;
                right: 5%;
                bottom: 80px;
                max-height: 400px;
            }
        }
    </style>
</head>
<body>
<!-- 动态氛围背景层：高级极光流光效果 -->
<div class="ambient-background">
    <div class="color-orb orb-1"></div>
    <div class="color-orb orb-2"></div>
    <div class="color-orb orb-3"></div>
</div>
<!-- 实时播放信息悬浮窗 -->
<div id="nowPlaying">
    <div class="module-trail"></div>
    <div class="now-playing-header">
        <h4>正在播放</h4>
        <div class="now-playing-controls">
            <div class="drag-handle">⋮</div>
            <div class="minimize-handle">−</div>
        </div>
    </div>
    <div id="nowPlayingInfo">
        <div class="track-title-favorite-container">
            <div class="track-title" id="trackTitle"></div>
            <button
                    class="favorite-button unliked"
                    id="favoriteButton"
                    title="添加到喜欢"
            ></button>
        </div>

        <div class="track-artist" id="trackArtist"></div>
        <div class="track-album" id="trackAlbum">-</div>

        <!-- 播放进度显示 -->
        <div class="progress-container">
            <div class="progress-track" id="progressTrack">
                <div class="progress-fill" id="progressFill"></div>
                <div class="progress-thumb" id="progressThumb"></div>
            </div>
            <div class="progress-time">
                <span id="currentTime">00:00</span>
                <span id="totalTime">00:00</span>
            </div>
        </div>

        <div class="track-source" id="trackSource"></div>

        <!-- 操作按钮区域 -->
        <div class="now-playing-actions">
            <div class="action-btns-group">
                <button id="aiInsightButton" class="action-btn" onclick="handleAiInsightClick()">音眸</button>
                <button id="lyricsButton" class="action-btn">歌词</button>
            </div>
        </div>

        <div class="favorite-indicators-container">
            <div class="favorite-indicators" id="favoriteIndicators"></div>
        </div>
    </div>
</div>

<!-- 歌词悬浮窗 -->
<div id="lyricsFloating">
    <div class="module-trail"></div>
    <div class="lyrics-header">
        <h4>歌词</h4>
        <div class="lyrics-controls">
            <button class="lyrics-close-btn" id="lyricsCloseBtn">×</button>
        </div>
    </div>
    <div class="lyrics-container" id="lyricsContainer">
        <div class="lyrics-text">暂无歌词数据</div>
    </div>
</div>

<!-- 悬浮侧边导航栏 -->
<nav class="navbar" id="mainNavbar">
    <div class="nav-toggle" id="navToggle">◀</div>
    <div class="navbar-content">
        <a href="#" class="logo">
            <span class="logo-icon">🎵</span>
            <span class="logo-text">音眸轨迹</span>
        </a>
        <ul class="nav-links">
            <li><a href="/" class="active" title="仪表板"><span class="nav-text">仪表板</span></a></li>
            <li><a href="#" id="insightListTab" title="音眸列表"><span class="nav-text">音眸列表</span></a></li>
            <li><a href="#" id="unscrobbledTab" title="未上报"><span class="nav-text">未上报列表</span></a></li>
           <!-- <li><a href="/recommendations" title="音乐推荐"><span class="nav-text">音乐推荐</span></a></li>
            <li><a href="/report" title="分析报告"><span class="nav-text">分析报告</span></a></li>
            <li><a href="/playCounts" title="播放统计"><span class="nav-text">播放统计</span></a></li>-->
        </ul>
    </div>
</nav>

<div class="container">
    <!-- 统计卡片 -->
    <div class="stats-container">
        <div class="stat-card">
            <div class="module-trail"></div>
            <div class="stat-header">
                <div class="stat-title">总播放次数</div>
                <div class="stat-icon icon-1">▶️</div>
            </div>
            <div class="stat-value" id="totalPlays">0</div>
            <div class="stat-change positive">↑ 12% 本月</div>
        </div>

        <div class="stat-card">
            <div class="module-trail"></div>
            <div class="stat-header">
                <div class="stat-title">曲目总数</div>
                <div class="stat-icon icon-2">🎵</div>
            </div>
            <div class="stat-value" id="totalTracks">0</div>
            <div class="stat-change positive">↑ 5% 本月</div>
        </div>

        <div class="stat-card">
            <div class="module-trail"></div>
            <div class="stat-header">
                <div class="stat-title">艺术家数量</div>
                <div class="stat-icon icon-3">🎤</div>
            </div>
            <div class="stat-value" id="totalArtists">0</div>
            <div class="stat-change negative">↓ 2% 本月</div>
        </div>

        <div class="stat-card">
            <div class="module-trail"></div>
            <div class="stat-header">
                <div class="stat-title">专辑数量</div>
                <div class="stat-icon icon-4">💿</div>
            </div>
            <div class="stat-value" id="totalAlbums">0</div>
            <div class="stat-change positive">↑ 8% 本月</div>
        </div>

        <!-- 播放来源统计卡片 -->
        <div class="stat-card">
            <div class="module-trail"></div>
            <div class="stat-header">
                <div class="stat-title">播放来源分布</div>
                <div class="stat-icon icon-1">📊</div>
            </div>
            <div
                    class="chart-container"
                    style="height: 120px; position: relative"
            >
                <canvas id="sourceChart"></canvas>
            </div>
        </div>
    </div>

    <!-- 图表区域 -->
    <div class="charts-container">
        <!-- 热门艺术家 -->
        <div class="chart-card">
            <div class="module-trail"></div>
            <div class="card-header">
                <div class="card-title">热门艺术家</div>
                <div class="time-filters">
                    <div class="time-filter active" data-type="plays">播放次数</div>
                    <div class="time-filter" data-type="tracks">曲目数</div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="artistChart"></canvas>
            </div>
        </div>

        <!-- 热门专辑 -->
        <div class="chart-card">
            <div class="module-trail"></div>
            <div class="card-header">
                <div class="card-title">热门专辑</div>
                <div class="time-filters">
                    <div class="time-filter active" data-days="7">7天</div>
                    <div class="time-filter" data-days="30">30天</div>
                    <div class="time-filter" data-days="90">90天</div>
                    <div class="time-filter" data-days="365">365天</div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="albumChart"></canvas>
            </div>
        </div>

        <!-- 热门流派 -->
        <div class="chart-card">
            <div class="module-trail"></div>
            <div class="card-header">
                <div class="card-title">口味流派</div>
                <button id="genreChartFullscreenBtn" class="fullscreen-btn">
                    全屏
                </button>
            </div>
            <div class="chart-container">
                <canvas id="genreChart"></canvas>
            </div>
        </div>

        <!-- 播放趋势图 -->
        <div class="chart-card">
            <div class="module-trail"></div>
            <!-- <div class="chart-card" style="grid-column: span 2"> -->
            <div class="card-header">
                <div class="card-title">播放趋势</div>
                <div style="display: flex; gap: 10px">
                    <div class="time-filters">
                        <div class="time-filter" data-range="7">7天</div>
                        <div class="time-filter active" data-range="30">30天</div>
                        <div class="time-filter" data-range="90">90天</div>
                    </div>
                    <button id="trendChartFullscreenBtn" class="fullscreen-btn">
                        全屏
                    </button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="trendChart"></canvas>
            </div>
        </div>
    </div>

    <!-- 最近播放和播放排行并排显示 -->
    <div class="rankings-container">
        <!-- 最近播放 -->
        <div class="ranking-card" id="recentPlaysCard">
            <div class="module-trail"></div>
            <div class="card-header">
                <div class="card-title">最近播放</div>
            </div>
            <ul class="ranking-list" id="recentPlaysList">
                <!-- 最近播放项目将通过JavaScript动态加载 -->
                <div class="loading">加载中...</div>
            </ul>
        </div>

        <!-- 播放排行榜 -->
        <div class="ranking-card" id="rankingCard">
            <div class="module-trail"></div>
            <div class="card-header" style="flex-wrap: wrap; gap: 10px;">
                <div class="card-title">播放排行榜</div>
                <div class="search-container" style="flex: 1; min-width: 150px;">
                    <input type="text" id="rankingSearchInput" placeholder="搜索歌名或艺术家..." 
                           style="width: 100%; padding: 6px 12px; border-radius: 20px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-primary); outline: none; font-size: 0.85rem;">
                </div>
                <div class="time-filters">
                    <div class="time-filter active" data-ranking="all">总排行</div>
                    <div class="time-filter" data-ranking="month">本月</div>
                    <div class="time-filter" data-ranking="week">本周</div>
                </div>
            </div>
            <ul class="ranking-list" id="rankingList">
                <!-- 排行榜项目将通过JavaScript动态加载 -->
                <div class="loading">加载中...</div>
            </ul>
        </div>
    </div>

    <!-- 未上报记录容器 -->
    <div id="unscrobbledContainer" style="display: none">
        <div class="chart-card">
            <div class="module-trail"></div>
            <div class="card-header">
                <div class="card-title">未上报记录</div>
                <div>
                    <button
                            id="syncSelectedBtn"
                            class="time-filter"
                            style="margin-right: 10px"
                    >
                        同步选中
                    </button>
                    <button id="refreshUnscrobbledBtn" class="time-filter">
                        刷新
                    </button>
                </div>
            </div>
            <div id="unscrobbledContent">
                <div class="loading">加载中...</div>
            </div>
            <div
                    id="pagination"
                    style="display: flex; justify-content: center; margin-top: 20px"
            >
                <button id="prevPage" class="time-filter" disabled>上一页</button>
                <span
                        id="pageInfo"
                        style="margin: 0 15px; line-height: 36px"
                ></span>
                <button id="nextPage" class="time-filter">下一页</button>
            </div>
        </div>
    </div>

    <!-- 音眸列表容器 -->
    <div id="insightListContainer" style="display: none">
        <div class="chart-card">
            <div class="module-trail"></div>
            <div class="card-header">
                <div class="card-title">音眸解析列表</div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <div style="position: relative;">
                        <input type="text" id="insightSearchInput" placeholder="按曲目模糊搜索..." 
                            style="padding: 6px 12px 6px 32px; border-radius: 20px; border: 1px solid var(--border-color); background: var(--bg-card); color: var(--text-main); font-size: 0.9em; width: 200px; outline: none;">
                        <span style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); opacity: 0.5;">🔍</span>
                    </div>
                    <button id="refreshInsightListBtn" class="time-filter">刷新</button>
                </div>
            </div>
            <div id="insightListContent">
                <div class="loading">加载中...</div>
            </div>
            <div id="insightPagination" style="display: flex; justify-content: center; margin-top: 20px">
                <button id="insightPrevPage" class="time-filter" disabled>上一页</button>
                <span id="insightPageInfo" style="margin: 0 15px; line-height: 36px"></span>
                <button id="insightNextPage" class="time-filter">下一页</button>
            </div>
        </div>
    </div>
    </div>
</div>

<!-- 关联流水日志 Modal -->
<div id="callLogModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="module-trail"></div>
        <div class="modal-header">
            <h3 id="callLogTitle">关联流水日志</h3>
            <span class="close-modal" id="closeCallLogModal">&times;</span>
        </div>
        <div class="modal-body" id="callLogContent" style="max-height: 60vh; overflow-y: auto;">
            <div class="loading">加载中...</div>
        </div>
    </div>
</div>

<script>
    // WebSocket连接
    let ws = null;

    // 音眸列表分页及搜索变量
    let currentInsightPage = 1;
    let insightPageSize = 20;
    let totalInsights = 0;
    let currentInsightKeyword = "";
    let insightSearchTimeout = null;

    // 自动切换日夜模式
    function toggleDarkModeBasedOnSystem() {
        const body = document.body;

        // 检查系统主题偏好
        if (
            window.matchMedia &&
            window.matchMedia("(prefers-color-scheme: dark)").matches
        ) {
            body.classList.add("dark-mode");
        } else {
            body.classList.remove("dark-mode");
        }

        // 重新加载所有图表以适应主题模式
        reloadAllCharts();
    }

    // 监听系统主题变化
    function watchSystemThemeChange() {
        if (window.matchMedia) {
            const mediaQuery = window.matchMedia("(prefers-color-scheme: dark)");
            mediaQuery.addEventListener("change", toggleDarkModeBasedOnSystem);
        }
    }

    // 检查是否处于暗色模式
    function isDarkMode() {
        return document.body.classList.contains("dark-mode");
    }

    // 获取图表的暗色模式配置
    function getChartDarkModeOptions() {
        if (isDarkMode()) {
            return {
                color: "#f0f0f0", // 文本颜色
                borderColor: "#444444", // 边框颜色
                backgroundColor: "#2c2c2c", // 背景颜色
                gridColor: "rgba(255, 255, 255, 0.1)", // 网格线颜色
                ticksColor: "#bdc3c7", // 刻度颜色
            };
        } else {
            return {
                color: "#2c3e50", // 文本颜色
                borderColor: "#e9ecef", // 边框颜色
                backgroundColor: "#ffffff", // 背景颜色
                gridColor: "rgba(0, 0, 0, 0.05)", // 网格线颜色
                ticksColor: "#7f8c8d", // 刻度颜色
            };
        }
    }

    // 重新加载所有图表以适应主题变化
    function reloadAllCharts() {
        // 重新初始化所有图表
        initSourceChart();
        initGenreChart();

        // 重新初始化当前激活的图表
        const trendRange =
            document
                .querySelector(".time-filter.active[data-range]")
                ?.getAttribute("data-range") || 30;
        initTrendChart(trendRange);

        const artistType =
            document
                .querySelector(".time-filter.active[data-type]")
                ?.getAttribute("data-type") || "plays";
        initArtistChart(artistType);

        const albumDays =
            document
                .querySelector(".time-filter.active[data-days]")
                ?.getAttribute("data-days") || 30;
        initAlbumChart(albumDays);

        // 如果未上报页面可见，重新加载其内容以适应主题变化
        const unscrobbledContainer = document.getElementById(
            "unscrobbledContainer"
        );
        if (
            unscrobbledContainer &&
            unscrobbledContainer.style.display !== "none"
        ) {
            loadUnscrobbledRecords();
        }

        // 更新全屏模式下的图表背景色
        updateFullscreenChartBackground();
    }

    // 更新全屏模式下的图表背景色
    function updateFullscreenChartBackground() {
        // 更新趋势图全屏背景
        const trendFullscreenOverlay = document.getElementById(
            "trendChartFullscreenOverlay"
        );
        if (trendFullscreenOverlay) {
            const isDark = document.body.classList.contains("dark-mode");
            const backgroundColor = isDark ? "#2c2c2c" : "white";
            const textColor = isDark ? "#f0f0f0" : "#2c3e50";
            trendFullscreenOverlay.querySelector("div").style.backgroundColor =
                backgroundColor;
            trendFullscreenOverlay.querySelector("div").style.color = textColor;
        }

        // 更新流派图全屏背景
        const genreFullscreenOverlay = document.getElementById(
            "genreChartFullscreenOverlay"
        );
        if (genreFullscreenOverlay) {
            const isDark = document.body.classList.contains("dark-mode");
            const backgroundColor = isDark ? "#2c2c2c" : "white";
            const textColor = isDark ? "#f0f0f0" : "#2c3e50";
            genreFullscreenOverlay.querySelector("div").style.backgroundColor =
                backgroundColor;
            genreFullscreenOverlay.querySelector("div").style.color = textColor;
        }
    }

    // 连接到WebSocket服务器
    function connectWebSocket() {
        // 创建WebSocket连接
        ws = new WebSocket("ws://" + window.location.host + "/ws");

        // 连接打开时的处理
        ws.onopen = function (event) {
            console.log("WebSocket连接已建立");
        };

        // 收到消息时的处理
        ws.onmessage = function (event) {
            const data = JSON.parse(event.data);
            if (data.type === "now_playing") {
                // 更新正在播放的信息
                updateNowPlaying(data.source, data.data);
            } else if (data.type === "stop") {
                // 隐藏正在播放的悬浮窗
                document.getElementById("nowPlaying").style.display = "none";
                // 清除进度更新定时器
                if (progressInterval) {
                    clearInterval(progressInterval);
                    progressInterval = null;
                }
            }
        };

        // 连接关闭时的处理
        ws.onclose = function (event) {
            console.log("WebSocket连接已关闭");
            // 清除进度更新定时器
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
            // 5秒后尝试重新连接
            setTimeout(connectWebSocket, 5000);
        };

        // 连接错误时的处理
        ws.onerror = function (error) {
            console.log("WebSocket连接出错:", error);
            // 清除进度更新定时器
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
        };
    }

    // 当前播放的曲目信息
    let currentTrackInfo = null;
    let currentSource = null;
    let currentPosition = 0; // 当前播放位置
    let trackDuration = 0; // 歌曲总时长
    let progressInterval = null; // 进度更新定时器
    let currentTrackInsight = null; // 当前曲目的 AI 解析结果 (兼容旧代码)
    
    // AI Insight 模块化状态管理
    const insightStates = {
        nowPlaying: { 
            insight: null, 
            allInsights: [], 
            eventSource: null,
            trackInfo: null
        },
        list: { 
            insight: null, 
            allInsights: [], 
            eventSource: null,
            trackInfo: null
        },
        details: { 
            insight: null, 
            allInsights: [], 
            eventSource: null,
            trackInfo: null
        }
    };

    let lastTrackKey = ""; // 用于检测切歌
    let currentRankingType = "all"; // 当前排行榜类型
    let rankingSearchKeyword = ""; // 当前排行榜搜索关键字
    let rankingSearchTimeout = null; // 排行榜搜索防抖计算器

    // 格式化时间（秒转为mm:ss）
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins.toString().padStart(2, "0")}:${secs
            .toString()
            .padStart(2, "0")}`;
    }

    // 更新播放进度显示
    function updateProgressDisplay() {
        if (trackDuration <= 0) return;

        // 更新进度条
        const progressPercent = (currentPosition / trackDuration) * 100;
        document.getElementById("progressFill").style.width = `${Math.min(
            progressPercent,
            100
        )}%`;

        // 更新时间显示
        document.getElementById("currentTime").textContent =
            formatTime(currentPosition);
        document.getElementById("totalTime").textContent =
            formatTime(trackDuration);

        // 更新当前位置
        currentPosition += 1;

        // 如果播放完成，清除定时器
        if (currentPosition >= trackDuration) {
            clearInterval(progressInterval);
            progressInterval = null;
        }
    }

    // 更新正在播放的信息
    function updateNowPlaying(source, data) {
        // 检测是否切歌
        const newTrackKey = `${data.artist}-${data.title}`;
        const trackChanged = newTrackKey !== lastTrackKey;
        lastTrackKey = newTrackKey;

        // 保存当前播放信息
        currentTrackInfo = data;
        currentSource = source;

        // 重置播放进度
        currentPosition = data.position || 0;
        trackDuration = data.duration || 0;

        // 清除之前的进度更新定时器
        if (progressInterval) {
            clearInterval(progressInterval);
            progressInterval = null;
        }

        // 启动新的进度更新定时器（如果歌曲有持续时间）
        if (trackDuration > 0) {
            // 立即更新一次显示
            updateProgressDisplay();
            // 每秒更新一次进度
            progressInterval = setInterval(updateProgressDisplay, 1000);
        }

        // 显示悬浮窗
        document.getElementById("nowPlaying").style.display = "block";

        // 如果歌曲改变了，且歌词窗口是打开的，则更新歌词
        if (trackChanged) {
            const lyricsFloating = document.getElementById("lyricsFloating");
            if (lyricsFloating && lyricsFloating.style.display === "block") {
                showLyrics();
            }
        }

        // 根据来源更新信息
        let sourceClass = "";
        let sourceText = "";

        if (source === "Audirvana") {
            document.getElementById("trackTitle").textContent = " " + data.title;
            document.getElementById("trackAlbum").textContent =
                "《 " + data.album + "》";
            document.getElementById("trackArtist").textContent =
                " - " + data.artist;
            sourceClass = "source-audirvana";
            sourceText = "Audirvana";
        } else if (source === "Roon") {
            document.getElementById("trackTitle").textContent = " " + data.title;
            document.getElementById("trackAlbum").textContent =
                "《 " + data.album + " 》";
            document.getElementById("trackArtist").textContent =
                " - " + data.artist;
            sourceClass = "source-roon";
            sourceText = "Roon";
        } else if (source === "Apple Music") {
            document.getElementById("trackTitle").textContent = " " + data.title;
            document.getElementById("trackAlbum").textContent =
                "《 " + data.album + " 》";
            document.getElementById("trackArtist").textContent =
                " - " + data.artist;
            sourceClass = "source-applemusic";
            sourceText = "AppleMusic";
        }

        // 更新播放渠道显示样式
        const trackSourceElement = document.getElementById("trackSource");
        trackSourceElement.textContent = sourceText;
        trackSourceElement.className = "play-source " + sourceClass;

        // 更新喜欢状态指示器
        updateFavoriteIndicators(data.apple_music, data.lastfm);

        // 更新点赞按钮状态
        updateFavoriteButtonState(data.apple_music);
    }

    // 更新喜欢状态指示器
    function updateFavoriteIndicators(appleMusicFav, lastFmFav) {
        const indicatorsContainer =
            document.getElementById("favoriteIndicators");
        indicatorsContainer.innerHTML = "";

        if (appleMusicFav && lastFmFav) {
            // 两个都喜欢，显示文本提示
            const indicator = document.createElement("span");
            indicator.className = "favorite-indicator";
            indicator.innerHTML = "Apple Music 和 Last.fm 都喜欢";
            indicator.title = "Apple Music 和 Last.fm 都喜欢";
            indicatorsContainer.appendChild(indicator);
        } else if (appleMusicFav) {
            // 只有Apple Music喜欢，显示文本提示
            const indicator = document.createElement("span");
            indicator.className = "favorite-indicator";
            indicator.innerHTML = "Apple Music 喜欢";
            indicator.title = "Apple Music 喜欢";
            indicatorsContainer.appendChild(indicator);
        } else if (lastFmFav) {
            // 只有Last.fm喜欢，显示文本提示
            const indicator = document.createElement("span");
            indicator.className = "favorite-indicator";
            indicator.innerHTML = "Last.fm 喜欢";
            indicator.title = "Last.fm 喜欢";
            indicatorsContainer.appendChild(indicator);
        }
        // 如果两个都不喜欢，则不显示任何指示器
    }

    // 更新点赞按钮状态
    function updateFavoriteButtonState(isLiked) {
        const favoriteButton = document.getElementById("favoriteButton");
        if (isLiked) {
            favoriteButton.innerHTML = "★";
            favoriteButton.className = "favorite-button liked";
            favoriteButton.title = "已添加到喜欢";
        } else {
            favoriteButton.innerHTML = "⭐︎";
            favoriteButton.className = "favorite-button unliked";
            favoriteButton.title = "添加到喜欢";
        }
    }

    let pendingAnalysisTrack = null; // 暂存待分析的曲目信息（用于处理详情页分析）

    // --- AI 解析交互逻辑重构 ---

    // 1. 处理正在播放面板的“AI 分析”点击
    async function handleAiInsightClick() {
        // 始终尝试 fetchTrackInsight(false) 即查询模式，默认上下文为 'nowPlaying'
        fetchTrackInsight(false, null, 'nowPlaying');
    }

    // 2. 显示模型选择弹窗
    let pendingAnalysisContext = 'nowPlaying'; // 暂存当前的上下文类型

    // 2. 显示模型选择弹窗
    function showModelPicker(targetTrack = null, contextType = 'nowPlaying') {
        // 如果传入了 targetTrack（比如从详情页传来），则暂存它
        pendingAnalysisTrack = targetTrack || currentTrackInfo;
        pendingAnalysisContext = contextType;
        showModal("aiModelPickerModal");
    }

    // 3. 用户选择模型后点击“开始分析”
    function startAnalysisWithSelectedModel() {
        hideModal("aiModelPickerModal");
        // 使用暂存的曲目信息和上下文开启强制分析流
        fetchTrackInsight(true, pendingAnalysisTrack, pendingAnalysisContext);
    }

    // 4. 发送对 AI 歌词解析的点赞 / 点踩反馈
    function recordAiFeedback(score, contextType = 'nowPlaying') {
        const state = insightStates[contextType];
        const insight = state.insight || currentTrackInsight;

        console.log("recordAiFeedback called with score:", score, "insight:", insight, "context:", contextType);
        if (!insight) {
            alert("暂无分析结果");
            return;
        }

        const insightId = currentTrackInsight.id || currentTrackInsight.ID;
        if (!insightId) {
            console.warn("Insight object missing ID property:", currentTrackInsight);
            alert("未找到解析 ID，无法提交反馈");
            return;
        }

        let comment = "";
        if (score === -1) {
            console.log("Triggering prompt for dislike comment");
            comment = prompt("我们很抱歉这次分析没能让你满意，请提供你的改进建议，以便我们优化：");
            console.log("User comment prompt result:", comment);
            if (comment === null) return; // 用户取消了输入
        }

        fetch(`/api/track-insight/${insightId}/feedback`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({score: score, comment: comment}),
        })
            .then(r => r.json())
            .then(data => {
                if (data.status === "ok") {
                    alert(score === 1 ? "感谢你的点赞！" : "感谢反馈，我们会持续改进。");
                } else {
                    console.error("反馈失败:", data);
                    alert("反馈失败: " + (data.error || "未知错误"));
                }
            })
            .catch(error => {
                console.error("发送反馈失败:", error);
                alert("发送反馈失败: " + error.message);
            });
    }

    async function shareInsight(contextType = 'nowPlaying') {
        const state = insightStates[contextType];
        const insight = state.insight || currentTrackInsight;

        if (!insight) {
            alert("暂无分析结果可分享");
            return;
        }

        const trackInfo = state.trackInfo || currentTrackInfo || pendingAnalysisTrack;
        if (!trackInfo) {
            alert("无法获取曲目信息");
            return;
        }

        const shareBtn = document.getElementById(`${contextType}-aiShareBtn`);
        const originalText = shareBtn ? shareBtn.textContent : "分享图片";
        if (shareBtn) {
            shareBtn.textContent = "生成中...";
            shareBtn.disabled = true;
        }

        try {
            const container = document.getElementById("shareInsightContainer");
            const titleEl = document.getElementById("shareTrackTitle");
            const metaEl = document.getElementById("shareTrackMeta");
            const contentEl = document.getElementById("shareInsightContent");
            const modelEl = document.getElementById("shareModelName");

            titleEl.textContent = trackInfo.title || trackInfo.track || "未知曲目";
            metaEl.textContent = `${trackInfo.artist || "未知艺术家"} · ${trackInfo.album || "未知专辑"}`;

            const modelName = insight.llm_provider || "AI";
            modelEl.textContent = modelName.charAt(0).toUpperCase() + modelName.slice(1);

            contentEl.innerHTML = generateShareInsightHtml(insight);

            container.style.position = "fixed";
            container.style.left = "0";
            container.style.top = "0";
            container.style.zIndex = "-1";

            await new Promise(resolve => setTimeout(resolve, 100));

            const canvas = await html2canvas(container, {
                scale: 3,
                useCORS: true,
                backgroundColor: null,
                logging: false
            });

            container.style.position = "absolute";
            container.style.left = "-9999px";
            container.style.top = "-9999px";

            canvas.toBlob(async (blob) => {
                if (!blob) {
                    alert("生成图片失败");
                    return;
                }
                try {
                    await navigator.clipboard.write([
                        new ClipboardItem({"image/png": blob})
                    ]);
                    alert("图片已复制到剪贴板！");
                } catch (err) {
                    console.error("复制失败:", err);
                    const link = document.createElement("a");
                    link.download = `insight-${trackInfo.artist}-${trackInfo.title}.png`;
                    link.href = URL.createObjectURL(blob);
                    link.click();
                    URL.revokeObjectURL(link.href);
                }
            }, "image/png");

        } catch (error) {
            console.error("分享失败:", error);
            alert("生成分享图片失败: " + error.message);
        } finally {
            if (shareBtn) {
                shareBtn.textContent = originalText;
                shareBtn.disabled = false;
            }
        }
    }

    let detailInsights = [];

    async function shareDetailInsight(index) {
        if (!window.currentDetailData || !window.currentDetailData.track) {
            alert("无法获取曲目信息");
            return;
        }

        const insights = window.currentDetailData.insights || [];
        const insight = insights[index];
        if (!insight) {
            alert("暂无分析结果可分享");
            return;
        }

        const track = window.currentDetailData.track;
        const trackInfo = {
            artist: track.artist,
            album: track.album,
            title: track.track
        };

        try {
            const container = document.getElementById("shareInsightContainer");
            const titleEl = document.getElementById("shareTrackTitle");
            const metaEl = document.getElementById("shareTrackMeta");
            const contentEl = document.getElementById("shareInsightContent");
            const modelEl = document.getElementById("shareModelName");

            titleEl.textContent = trackInfo.title || "未知曲目";
            metaEl.textContent = `${trackInfo.artist || "未知艺术家"} · ${trackInfo.album || "未知专辑"}`;

            const modelName = insight.llm_provider || "AI";
            modelEl.textContent = modelName.charAt(0).toUpperCase() + modelName.slice(1);

            contentEl.innerHTML = generateShareInsightHtml(insight);

            container.style.position = "fixed";
            container.style.left = "0";
            container.style.top = "0";
            container.style.zIndex = "-1";

            await new Promise(resolve => setTimeout(resolve, 100));

            const canvas = await html2canvas(container, {
                scale: 3,
                useCORS: true,
                backgroundColor: null,
                logging: false
            });

            container.style.position = "absolute";
            container.style.left = "-9999px";
            container.style.top = "-9999px";

            canvas.toBlob(async (blob) => {
                if (!blob) {
                    alert("生成图片失败");
                    return;
                }
                try {
                    await navigator.clipboard.write([
                        new ClipboardItem({"image/png": blob})
                    ]);
                    alert("图片已复制到剪贴板！");
                } catch (err) {
                    console.error("复制失败:", err);
                    const link = document.createElement("a");
                    link.download = `insight-${trackInfo.artist}-${trackInfo.title}.png`;
                    link.href = URL.createObjectURL(blob);
                    link.click();
                    URL.revokeObjectURL(link.href);
                }
            }, "image/png");

        } catch (error) {
            console.error("分享失败:", error);
            alert("生成分享图片失败: " + error.message);
        }
    }

    function parseTaggedContent(text, tagName) {
        const regex = new RegExp(`<${tagName}>([\\s\\S]*?)<(?:\\/)?${tagName}>`, 'g');
        const results = [];
        let match;
        while ((match = regex.exec(text)) !== null) {
            results.push(match[1].trim());
        }
        return results;
    }

    function parseLyricsTranslation(text) {
        if (!text) return [];
        const cleanText = text.replace(/\\n/g, '\n');
        const originals = parseTaggedContent(cleanText, 'original');
        const translations = parseTaggedContent(cleanText, 'translation');
        const result = [];
        const maxLen = Math.max(originals.length, translations.length);
        for (let i = 0; i < maxLen; i++) {
            result.push({
                original: originals[i] || '',
                translation: translations[i] || ''
            });
        }
        return result;
    }

    function parseAppreciateAnalysis(text) {
        if (!text) return [];
        const cleanText = text.replace(/\\n/g, '\n');

        const result = [];
        let currentGroup = { sectionTitle: '', items: [], explain: '' };

        const regex = /<(original|translation|explain)>([\s\S]*?)<(?:\/)?\1>/g;
        let match;
        let lastIndex = 0;

        while ((match = regex.exec(cleanText)) !== null) {
            const tag = match[0];
            const tagName = match[1];
            const content = match[2].trim();

            const textBeforeTag = cleanText.slice(lastIndex, match.index).trim();
            if (textBeforeTag && textBeforeTag.includes('段')) {
                currentGroup.sectionTitle = textBeforeTag.split('\n')[0].trim();
            }

            if (tagName === 'original') {
                currentGroup.items.push({original: content, translation: ''});
            } else if (tagName === 'translation') {
                if (currentGroup.items.length > 0) {
                    currentGroup.items[currentGroup.items.length - 1].translation = content;
                }
            } else if (tagName === 'explain') {
                currentGroup.explain = content;
                if (currentGroup.items.length > 0 || currentGroup.explain) {
                    result.push(currentGroup);
                }
                currentGroup = { sectionTitle: '', items: [], explain: '' };
            }
            lastIndex = match.index + tag.length;
        }

        if (currentGroup.items.length > 0 || currentGroup.explain) {
            const textAfter = cleanText.slice(lastIndex).trim();
            if (textAfter && textAfter.includes('段')) {
                currentGroup.sectionTitle = textAfter.split('\n')[0].trim();
            }
            result.push(currentGroup);
        }

        return result;
    }

    function generateShareInsightHtml(insight) {
        let html = '';

        if (insight.lyrics_translation) {
            const lyrics = parseLyricsTranslation(insight.lyrics_translation);
            if (lyrics.length > 0) {
                html += `<div style="margin-bottom: 20px;">
              <h3 style="font-size: 13px; font-weight: 600; margin: 0 0 10px 0; opacity: 0.9;">📝 歌词翻译</h3>
              <div style="font-size: 12px; line-height: 1.8;">`;
                lyrics.forEach(item => {
                    html += `<div style="margin-bottom: 8px;">
                <div style="opacity: 0.7; font-style: italic;">${item.original}</div>
                ${item.translation ? `<div style="font-weight: 500;">${item.translation}</div>` : ''}
              </div>`;
                });
                html += `</div></div>`;
            }
        }

        if (insight.analysis_summary) {
            const summary = insight.analysis_summary.replace(/\\n/g, '\n');
            html += `<div style="margin-bottom: 20px;">
            <h3 style="font-size: 13px; font-weight: 600; margin: 0 0 10px 0; opacity: 0.9;">💡 曲目解读</h3>
            <div style="font-size: 12px; line-height: 1.8; white-space: pre-wrap;">${summary}</div>
          </div>`;
        }

        try {
            let sections = insight.analysis_by_section;
            if (typeof sections === 'string' && sections.trim() !== '') {
                try {
                    sections = JSON.parse(sections);
                } catch (e) {
                    sections = null;
                }
            }
            if (sections && Object.keys(sections).length > 0) {
                const sectionTitles = {
                    "literary_analysis": "文学解读",
                    "musical_analysis": "乐评分析",
                    "cultural_context": "文化背景",
                    "translation_notes": "翻译说明",
                    "appreciate_analysis": "分句赏析"
                };
                html += `<div style="margin-bottom: 16px;">
              <h3 style="font-size: 13px; font-weight: 600; margin: 0 0 10px 0; opacity: 0.9;">🧩 深度解析</h3>`;
                Object.entries(sections).forEach(([section, content]) => {
                    const title = sectionTitles[section] || section;
                    const contentStr = typeof content === 'string' ? content.replace(/\\n/g, '\n') : JSON.stringify(content);

                    if (section === 'appreciate_analysis') {
                        const parsed = parseAppreciateAnalysis(contentStr);
                        if (parsed.length > 0) {
                            html += `<div style="margin-bottom: 12px; padding-left: 10px; border-left: 2px solid rgba(255,255,255,0.4);">
                        <h4 style="font-size: 12px; font-weight: 600; margin: 0 0 8px 0;">${title}</h4>`;
                            parsed.forEach((group, idx) => {
                                if (group.sectionTitle) {
                                    html += `<div style="margin: 10px 0 6px 0; font-size: 11px; font-weight: 600; color: #e2e8f0; opacity: 0.9;">${group.sectionTitle}</div>`;
                                }
                                group.items.forEach(item => {
                                    html += `<div style="margin-bottom: 4px; font-size: 11px;">
                                <div style="opacity: 0.7; font-style: italic;">${item.original}</div>
                                ${item.translation ? `<div style="font-weight: 500;">${item.translation}</div>` : ''}
                              </div>`;
                                });
                                if (group.explain) {
                                    html += `<div style="margin: 6px 0 12px 0; padding: 8px 10px; background: rgba(255,255,255,0.1); border-radius: 6px; font-size: 11px; line-height: 1.7; font-weight: 500;">${group.explain}</div>`;
                                }
                            });
                            html += `</div>`;
                        }
                    } else {
                        html += `<div style="margin-bottom: 12px; padding-left: 10px; border-left: 2px solid rgba(255,255,255,0.4);">
                    <h4 style="font-size: 12px; font-weight: 600; margin: 0 0 6px 0;">${title}</h4>
                    <div style="font-size: 11px; line-height: 1.7; white-space: pre-wrap; opacity: 0.9;">${contentStr}</div>
                  </div>`;
                    }
                });
                html += `</div>`;
            }
        } catch (err) {
            console.error("渲染分段解析时出错:", err);
        }

        if (insight.background_info && insight.background_info.length > 5) {
            html += `<div style="margin-bottom: 20px;">
            <h3 style="font-size: 13px; font-weight: 600; margin: 0 0 10px 0; opacity: 0.9;">🎨 创作背景</h3>
            <div style="font-size: 12px; line-height: 1.8;">${insight.background_info}</div>
          </div>`;
        }

        if (insight.era_context) {
            html += `<div style="margin-bottom: 16px;">
            <h3 style="font-size: 13px; font-weight: 600; margin: 0 0 10px 0; opacity: 0.9;">🌍 时代语境</h3>
            <div style="font-size: 12px; line-height: 1.8;">${insight.era_context}</div>
          </div>`;
        }

        if (!html) {
            html = `<div style="text-align: center; opacity: 0.7; padding: 30px;">
            <div style="font-size: 32px; margin-bottom: 10px;">🎵</div>
            <div style="font-size: 13px;">暂无详细分析内容</div>
          </div>`;
        }

        return html;
    }

    function getRandomLoadingHtml() {
        const texts = [
            "正在为您捕捉旋律中的灵魂...",
            "正在为您解读词句间的深意...",
            "正在为您连接音乐与情感的彼岸...",
            "正在为您寻觅旋律背后的故事...",
            "正在为您雕琢每一句诗词意境..."
        ];
        const text = "音眸" + texts[Math.floor(Math.random() * texts.length)];
        return `
          <div class="ai-loading-wrapper">
            <div class="ai-ripple"><div></div><div></div></div>
            <div class="ai-loading-text">${text}</div>
          </div>
        `;
    }

    // 5. 核心分析驱动函数
    async function fetchTrackInsight(force = false, targetTrack = null, contextType = 'nowPlaying') {
        // 这里的逻辑：传入了 targetTrack 就用传入的，否则用全局 currentTrackInfo
        const trackInfo = targetTrack || currentTrackInfo;
        if (!trackInfo) {
            alert("无法获取曲目元数据，请确保页面已加载曲目信息");
            return;
        }

        const state = insightStates[contextType];
        state.trackInfo = trackInfo;

        const aiButton = document.getElementById("aiInsightButton");
        const sseEnabled = document.getElementById("aiModelSseToggle").checked;
        const streamContent = document.getElementById(`${contextType}-aiInsightStreamContent`);
        const actionFooter = document.getElementById(`${contextType}-aiActionFooter`);
        const reanalyzeBtn = document.getElementById(`${contextType}-aiReanalyzeBtn`);

        // 基础参数
        const artist = trackInfo.artist;
        const album = trackInfo.album;
        const track = trackInfo.title || trackInfo.track;

        // 如果是强制分析，必须有已选模型
        let modelType = "";
        if (force) {
            modelType = document.getElementById('aiModelSelect').value;
            if (aiButton) aiButton.disabled = true;
            if (streamContent) streamContent.innerHTML = getRandomLoadingHtml();
            if (actionFooter) actionFooter.style.display = "none";
            showModal(`${contextType}InsightModal`);
        } else {
            // 仅查询模式
            if (aiButton) aiButton.disabled = true;
        }

        if (force && sseEnabled) {
            // --- SSE 流式模式 ---
            // 如果已有连接先关闭
            if (state.eventSource) state.eventSource.close();
            
            const url = `/api/track-insight-stream?artist=${encodeURIComponent(artist)}&album=${encodeURIComponent(album)}&track=${encodeURIComponent(track)}&force=true&modelType=${encodeURIComponent(modelType)}`;
            const eventSource = new EventSource(url);
            state.eventSource = eventSource;
            let fullText = "";

            eventSource.onmessage = function (event) {
                if (streamContent) {
                    if (streamContent.querySelector(".ai-loading-wrapper")) streamContent.innerHTML = "";
                    fullText += event.data;
                    streamContent.textContent = fullText;
                    streamContent.scrollTop = streamContent.scrollHeight;
                }
            };

            eventSource.onerror = function (err) {
                eventSource.close();
                state.eventSource = null;
                if (aiButton) aiButton.disabled = false;
                if (fullText.length > 0) {
                    // 分析完成，执行非强制查询以刷新结果展示排版
                    fetchTrackInsight(false, trackInfo, contextType);
                } else {
                    // 分析失败
                    streamContent.innerHTML = '<div class="error">对话意外中断或该模型暂不支持流式返回。</div>';
                    actionFooter.style.display = "flex";
                    reanalyzeBtn.textContent = "开始分析";
                }
            };
        } else if (force) {
            // --- 强制执行分析模式 (POST) ---
            try {
                const body = {artist, album, track, modelType};
                const response = await fetch("/api/track-insight", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify(body)
                });
                if (aiButton) aiButton.disabled = false;
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || "分析失败");

                const insights = data.insights || (data.insight ? [data.insight] : []);
                handleInsightResponse(insights, true, contextType);
            } catch (err) {
                handleInsightError(err, true, contextType);
            }
        } else {
            // --- 纯查询模式 (GET) ---
            try {
                const url = `/api/track-insight?artist=${encodeURIComponent(artist)}&album=${encodeURIComponent(album)}&track=${encodeURIComponent(track)}`;
                const response = await fetch(url);
                if (aiButton) aiButton.disabled = false;
                const data = await response.json();

                const insights = data.insights || [];
                if (insights.length > 0) {
                    handleInsightResponse(insights, false, contextType);
                } else {
                    handleNoInsight(contextType);
                }
            } catch (err) {
                handleInsightError(err, false, contextType);
            }
        }
    }

    // 辅助：处理解析成功响应
    function handleInsightResponse(insights, isFromForce, contextType) {
        const aiButton = document.getElementById("aiInsightButton");
        const actionFooter = document.getElementById(`${contextType}-aiActionFooter`);
        const reanalyzeBtn = document.getElementById(`${contextType}-aiReanalyzeBtn`);

        insightStates[contextType].insight = insights[0];
        currentTrackInsight = insights[0]; // 保持兼容

        renderInsight(insights, contextType);
        
        if (actionFooter) actionFooter.style.display = "flex";
        if (reanalyzeBtn) reanalyzeBtn.textContent = "重新分析";
        if (!isFromForce) showModal(`${contextType}InsightModal`);
    }

    // 辅助：处理无解析数据
    function handleNoInsight(contextType) {
        const aiButton = document.getElementById("aiInsightButton");
        const streamContent = document.getElementById(`${contextType}-aiInsightStreamContent`);
        const actionFooter = document.getElementById(`${contextType}-aiActionFooter`);
        const reanalyzeBtn = document.getElementById(`${contextType}-aiReanalyzeBtn`);

        if (streamContent) streamContent.innerHTML = '<div class="loading">该曲目暂无分析数据，请点击下方按钮开始分析。</div>';
        if (actionFooter) actionFooter.style.display = "flex";
        if (reanalyzeBtn) reanalyzeBtn.textContent = "开始分析";
        showModal(`${contextType}InsightModal`);
    }

    // 辅助：处理错误
    function handleInsightError(err, isFromForce, contextType) {
        const aiButton = document.getElementById("aiInsightButton");
        const streamContent = document.getElementById(`${contextType}-aiInsightStreamContent`);
        const actionFooter = document.getElementById(`${contextType}-aiActionFooter`);

        console.error("AI Insight Error:", err);
        if (aiButton) aiButton.disabled = false;
        if (streamContent) streamContent.innerHTML = `<div class="error">${err.message}</div>`;
        if (actionFooter) actionFooter.style.display = "flex";
    }

    // 6. 初始化 AI 模型
    async function initAIModels() {
        try {
            const resp = await fetch("/api/ai-models");
            const data = await resp.json();
            const select = document.getElementById("aiModelSelect");
            if (data.models && data.models.length > 0) {
                select.innerHTML = "";
                data.models.forEach(m => {
                    const opt = document.createElement("option");
                    opt.value = m;
                    opt.textContent = m.charAt(0).toUpperCase() + m.slice(1);
                    if (m === "ollama") opt.selected = true;
                    select.appendChild(opt);
                });
            }
        } catch (e) {
            console.error("加载模型失败:", e);
        }
    }

    initAIModels();

    let allInsights = [];

    // 渲染结构化解析结果
    function renderInsight(data, contextType = 'nowPlaying') {
        const streamContent = document.getElementById(`${contextType}-aiInsightStreamContent`);
        if (!data || !streamContent) return;

        // 标准化输入为数组
        let insights = [];
        if (Array.isArray(data)) {
            insights = data;
        } else if (data.insights && Array.isArray(data.insights)) {
            insights = data.insights;
        } else {
            insights = [data];
        }

        if (insights.length === 0) {
            streamContent.innerHTML = '<div class="error">暂无分析数据</div>';
            return;
        }

        const state = insightStates[contextType];
        state.allInsights = insights;
        state.insight = insights[0];
        currentTrackInsight = insights[0]; // 兼容

        // 设置为正常布局
        streamContent.style.whiteSpace = "normal";

        let html = '';

        // 如果有多个结果，显示 Tab
        if (insights.length > 1) {
            const positiveTotal = insights.reduce((sum, i) => sum + Math.max(0, i.total_score || 0), 0);
            html += '<div class="insight-tabs">';
            insights.forEach((insight, index) => {
                const date = new Date(insight.created_at || Date.now());
                const timeStr = date.toLocaleString('zh-CN', {
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                const activeClass = index === 0 ? 'active' : '';
                const totalScore = insight.total_score || 0;
                let supportRate;
                if (positiveTotal > 0) {
                    supportRate = ((totalScore / positiveTotal) * 100).toFixed(1);
                } else {
                    supportRate = totalScore === 0 ? '0.0' : (totalScore > 0 ? '100.0' : '-100.0');
                }
                html += `<div class="insight-tab ${activeClass}" onclick="switchInsightTrackTab(${index}, '${contextType}')" title="总分: ${totalScore} | 支持率: ${supportRate}%">分析 ${insights.length - index} <small>(${timeStr})</small></div>`;
            });
            html += '</div>';
        }

        html += `<div id="${contextType}-insight-content-container">`;
        insights.forEach((insight, index) => {
            const displayStyle = index === 0 ? 'block' : 'none';
            html += `<div class="insight-item" id="${contextType}-insight-item-${index}" style="display: ${displayStyle};">`;
            html += generateInsightContentHtml(insight);
            html += '</div>';
        });
        html += '</div>';

        streamContent.innerHTML = html;
        streamContent.scrollTop = 0;
    }

    function switchInsightTrackTab(index, contextType) {
        const container = document.getElementById(`${contextType}-aiInsightStreamContent`);
        if (!container) return;
        
        container.querySelectorAll('.insight-tab').forEach((tab, i) => {
            if (i === index) tab.classList.add('active');
            else tab.classList.remove('active');
        });
        container.querySelectorAll('.insight-item').forEach((item, i) => {
            if (i === index) item.style.display = 'block';
            else item.style.display = 'none';
        });
        
        const state = insightStates[contextType];
        if (state.allInsights[index]) {
            state.insight = state.allInsights[index];
            currentTrackInsight = state.insight; // 兼容
        }
    }

    function switchInsightTab(tabName, contextType = 'nowPlaying') {
        console.log("switchInsightTab:", tabName, "context:", contextType);
        const modal = document.getElementById(`${contextType}InsightModal`);
        if (!modal) return;

        // 切换标签页 UI
        modal.querySelectorAll('.insight-tab').forEach(tab => {
            const label = tab.textContent;
            if (label.includes('详情') && tabName === 'summary') tab.classList.add('active');
            else if (label.includes('反馈') && tabName === 'feedback') tab.classList.add('active');
            else if (label.includes('原始') && tabName === 'raw') tab.classList.add('active');
            else tab.classList.remove('active');
        });

        // 切换内容区域
        const summaryTab = modal.querySelector(`#${contextType}-insightSummaryTab`);
        const feedbackTab = modal.querySelector(`#${contextType}-insightFeedbackTab`);
        const rawTab = modal.querySelector(`#${contextType}-insightRawTab`);

        if (summaryTab) summaryTab.style.display = tabName === 'summary' ? "block" : "none";
        if (feedbackTab) feedbackTab.style.display = tabName === 'feedback' ? "block" : "none";
        if (rawTab) rawTab.style.display = tabName === 'raw' ? "block" : "none";

        if (tabName === 'feedback') {
            loadInsightFeedback(contextType);
        } else if (tabName === 'raw') {
            const state = insightStates[contextType];
            const content = modal.querySelector(`#${contextType}-insightRawContent pre`);
            if (content && state.insight) {
                content.textContent = JSON.stringify(state.insight, null, 2);
            }
        }
    }

    async function loadInsightFeedback(contextType) {
        const state = insightStates[contextType];
        const insight = state.insight || currentTrackInsight;
        const container = document.getElementById(`${contextType}-insightFeedbackContent`);
        if (!container) return;

        if (!insight) {
            container.innerHTML = '<div class="info">暂无分析结果</div>';
            return;
        }

        const insightId = insight.id || insight.ID;
        try {
            const resp = await fetch(`/api/insights/${insightId}/feedbacks`);
            if (!resp.ok) throw new Error("加载反馈失败");
            const data = await resp.json();
            const feedbacks = data.feedbacks || [];
            
            if (feedbacks.length === 0) {
                container.innerHTML = '<div class="info">暂无用户反馈</div>';
                return;
            }

            let html = '<div class="feedback-list" style="display: flex; flex-direction: column; gap: 12px;">';
            feedbacks.forEach(f => {
                const date = new Date(f.created_at).toLocaleString();
                html += `
                    <div class="feedback-item" style="padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; border: 1px solid var(--border-color);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-weight: 600; color: ${f.score > 0 ? '#2ecc71' : '#e74c3c'};">${f.score > 0 ? '👍 赞' : '👎 踩'}</span>
                            <span style="font-size: 0.8rem; color: var(--text-secondary);">${date}</span>
                        </div>
                        ${f.comment ? `<div style="font-size: 0.9rem; line-height: 1.5;">${f.comment}</div>` : '<i style="font-size: 0.85rem; color: var(--text-secondary);">无评论</i>'}
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        } catch (e) {
            container.innerHTML = `<div class="error">${e.message}</div>`;
        }
    }

    function generateInsightContentHtml(insight) {
        let html = '<div class="insight-container">';

        const lyrics = parseLyricsTranslation(insight.lyrics_translation);
        if (lyrics.length > 0) {
            html += `
            <div class="insight-section">
              <h3><span>📝</span> 歌词翻译</h3>
              <div class="lyrics-grid">
                ${(() => {
                let lyricsHtml = '';
                lyrics.forEach(item => {
                    lyricsHtml += `
                      <div class="lyrics-line">
                        <div class="lyrics-original">${item.original}</div>
                        ${item.translation ? `<div class="lyrics-translated">${item.translation}</div>` : ''}
                      </div>
                    `;
                });
                return lyricsHtml;
            })()}
              </div>
            </div>
          `;
        }

        if (insight.analysis_summary) {
            html += `
            <div class="insight-section">
              <h3><span>💡</span> 曲目解读</h3>
              <div class="analysis-text" style="white-space: pre-wrap; line-height: 1.8;">${insight.analysis_summary.replace(/\\n/g, '\n')}</div>
            </div>
          `;
        }

        try {
            let sections = insight.analysis_by_section;
            if (typeof sections === 'string' && sections.trim() !== '') {
                try {
                    sections = JSON.parse(sections);
                } catch (e) {
                    sections = null;
                }
            }

            if (sections && Object.keys(sections).length > 0) {
                const sectionTitles = {
                    "literary_analysis": "文学翻译家的深度解读",
                    "musical_analysis": "乐评人的专业评价",
                    "cultural_context": "文化史学家的背景与时代分析",
                    "translation_notes": "翻译难点说明或语言特色分析",
                    "appreciate_analysis": "分句进行赏析和解读"
                };

                let sectionsHtml = '';
                Object.entries(sections).forEach(([section, content]) => {
                    const title = sectionTitles[section] || section;
                    const contentStr = typeof content === 'string' ? content.replace(/\\n/g, '\n') : JSON.stringify(content);

                    if (section === 'appreciate_analysis') {
                        const parsed = parseAppreciateAnalysis(contentStr);
                        if (parsed.length > 0) {
                            let appreciateHtml = '';
                            parsed.forEach((group, idx) => {
                                if (group.sectionTitle) {
                                    appreciateHtml += `
                                        <div class="section-title-block" style="margin: 16px 0 8px 0; padding: 8px 12px; background: rgba(102, 126, 234, 0.08); border-radius: 6px; border-left: 3px solid var(--primary-color);">
                                            <span class="section-title-text" style="font-weight: 600; color: var(--primary-color); font-size: 0.95rem;">${group.sectionTitle}</span>
                                        </div>
                                    `;
                                }
                                group.items.forEach(item => {
                                    appreciateHtml += `
                                        <div class="lyrics-line">
                                            <div class="lyrics-original">${item.original}</div>
                                            ${item.translation ? `<div class="lyrics-translated">${item.translation}</div>` : ''}
                                        </div>
                                    `;
                                });
                                if (group.explain) {
                                    appreciateHtml += `
                                        <div class="explain-block">
                                            <div class="explain-content">${group.explain}</div>
                                        </div>
                                    `;
                                }
                            });
                            sectionsHtml += `
                                <div class="section-item appreciate-item">
                                    <span class="section-name">${title}</span>
                                    <div class="appreciate-content">${appreciateHtml}</div>
                                </div>
                            `;
                        }
                    } else {
                        sectionsHtml += `
                            <div class="section-item">
                                <span class="section-name">${title}</span>
                                <div class="section-content" style="white-space: pre-wrap; line-height: 1.8;">${contentStr}</div>
                            </div>
                        `;
                    }
                });

                html += `
                    <div class="insight-section">
                        <h3><span>🧩</span> 分段解析</h3>
                        <div class="analysis-sections">${sectionsHtml}</div>
                    </div>
                `;
            }
        } catch (err) {
            console.error("渲染分段解析时出错:", err);
        }

        if (insight.background_info && insight.background_info.length > 5) {
            html += `
            <div class="insight-section">
              <h3><span>🎨</span> 创作背景</h3>
              <div class="analysis-text">${insight.background_info}</div>
            </div>
          `;
        }

        if (insight.era_context) {
            html += `
            <div class="insight-section">
              <h3><span>🌍</span> 时代语境</h3>
              <div class="analysis-text">${insight.era_context}</div>
            </div>
          `;
        }

        html += `
            <div style="margin-top: 10px; font-size: 0.75rem; color: var(--text-secondary); text-align: right; opacity: 0.7;">
              由 ${insight.llm_provider || 'AI'} 提供深度分析
            </div>
          </div>
        `;
        return html;
    }

    // 点赞按钮点击事件处理
    function handleFavoriteButtonClick() {
        if (!currentTrackInfo || !currentSource) {
            console.log("没有正在播放的曲目");
            return;
        }

        const favoriteButton = document.getElementById("favoriteButton");
        const isCurrentlyLiked = favoriteButton.classList.contains("liked");

        // 如果已经收藏，则不执行任何操作
        if (isCurrentlyLiked) {
            return;
        }

        // 立即更新按钮状态，提供即时反馈
        updateFavoriteButtonState(!isCurrentlyLiked);

        // 发送请求到后端处理收藏逻辑
        fetch("/api/favorite", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                artist: currentTrackInfo.artist,
                album: currentTrackInfo.album,
                track: currentTrackInfo.title,
                source: currentSource,
                favorite: !isCurrentlyLiked,
            }),
        })
            .then((response) => {
                if (!response.ok) {
                    throw new Error("网络响应错误");
                }
                return response.json();
            })
            .then((data) => {
                // 更新喜欢状态指示器
                updateFavoriteIndicators(data.apple_music, data.lastfm);
                // 更新按钮状态（以防后端返回的状态与前端不一致）
                updateFavoriteButtonState(data.apple_music);
            })
            .catch((error) => {
                console.error("收藏操作失败:", error);
                // 恢复按钮原始状态
                updateFavoriteButtonState(isCurrentlyLiked);
                alert("收藏操作失败: " + error.message);
            });
    }

    // 初始化正在播放悬浮窗的拖动和缩小功能
    function initNowPlayingDrag() {
        const nowPlaying = document.getElementById("nowPlaying");
        const header = document.querySelector(".now-playing-header");
        const minimizeHandle = document.querySelector(".minimize-handle");

        if (!nowPlaying || !header || !minimizeHandle) return;

        let isDragging = false;
        let offsetX, offsetY;
        let originalX, originalY;

        // 鼠标按下事件（拖动）- 在整个标题栏都可以触发
        header.addEventListener("mousedown", function (e) {
            // 如果点击的是缩小按钮，则不触发拖动
            if (e.target === minimizeHandle) return;

            isDragging = true;
            nowPlaying.classList.add("dragging");

            // 获取悬浮窗当前位置
            const rect = nowPlaying.getBoundingClientRect();
            originalX = rect.left;
            originalY = rect.top;

            // 计算鼠标相对于悬浮窗的位置
            offsetX = e.clientX - originalX;
            offsetY = e.clientY - originalY;

            // 防止文本选择
            e.preventDefault();
        });

        // 鼠标移动事件（拖动）
        document.addEventListener("mousemove", function (e) {
            if (!isDragging) return;

            // 计算悬浮窗的新位置
            const x = e.clientX - offsetX;
            const y = e.clientY - offsetY;

            // 设置悬浮窗位置
            nowPlaying.style.left = x + "px";
            nowPlaying.style.top = y + "px";
            nowPlaying.style.right = "auto";
        });

        // 鼠标释放事件（拖动）
        document.addEventListener("mouseup", function () {
            isDragging = false;
            nowPlaying.classList.remove("dragging");
        });

        // 点击缩小/展开按钮
        minimizeHandle.addEventListener("click", function () {
            nowPlaying.classList.toggle("minimized");
        });
    }



    // ========== 歌词功能 ==========
    let currentLyricsData = null;
    let lyricsUpdateInterval = null;

    function parseLRC(lrcText) {
        const lines = lrcText.split('\n');
        const lrcData = [];
        const timeRegex = /\[(\d{2}):(\d{2})(?:\.(\d{2,3}))?\]/g;

        lines.forEach(line => {
            const matches = [...line.matchAll(timeRegex)];
            if (matches.length > 0) {
                const lastMatch = matches[matches.length - 1];
                const minutes = parseInt(lastMatch[1]);
                const seconds = parseInt(lastMatch[2]);
                const milliseconds = lastMatch[3] ? parseInt(lastMatch[3].padEnd(3, '0')) : 0;
                const time = minutes * 60 + seconds + milliseconds / 1000;
                const text = line.replace(timeRegex, '').trim();
                if (text) {
                    lrcData.push({time, text});
                }
            }
        });
        lrcData.sort((a, b) => a.time - b.time);
        return lrcData;
    }

    async function fetchLyrics(artist, album, track) {
        try {
            const params = new URLSearchParams({
                artist: artist,
                album: album || '',
                track: track
            });
            const response = await fetch(`/api/track-lyrics?${params}`);
            if (!response.ok) throw new Error('获取歌词失败');
            return await response.json();
        } catch (error) {
            console.error('获取歌词失败:', error);
            return {lyrics: '', has_lrc: false};
        }
    }

    async function showLyrics() {
        if (!currentTrackInfo) {
            alert('当前没有正在播放的曲目');
            return;
        }
        const lyricsFloating = document.getElementById('lyricsFloating');
        const lyricsContainer = document.getElementById('lyricsContainer');
        lyricsContainer.innerHTML = '<div class="lyrics-text">正在加载歌词...</div>';
        lyricsFloating.style.display = 'block';

        const lyricsData = await fetchLyrics(
            currentTrackInfo.artist,
            currentTrackInfo.album,
            currentTrackInfo.title
        );

        if (!lyricsData.lyrics) {
            lyricsContainer.innerHTML = '<div class="lyrics-text">暂无歌词数据</div>';
            currentLyricsData = null;
            return;
        }

        if (lyricsData.has_lrc) {
            currentLyricsData = parseLRC(lyricsData.lyrics);
            renderLRCLyrics(currentLyricsData);
            startLyricsSync();
        } else {
            lyricsContainer.innerHTML = `<div class="lyrics-text">${lyricsData.lyrics}</div>`;
            currentLyricsData = null;
            stopLyricsSync();
        }
    }

    function renderLRCLyrics(lrcData) {
        const lyricsContainer = document.getElementById('lyricsContainer');
        lyricsContainer.innerHTML = '';
        lrcData.forEach((item, index) => {
            const lineDiv = document.createElement('div');
            lineDiv.className = 'lyrics-line';
            lineDiv.textContent = item.text;
            lineDiv.dataset.time = item.time;
            lineDiv.dataset.index = index;
            lyricsContainer.appendChild(lineDiv);
        });
    }

    function startLyricsSync() {
        stopLyricsSync();
        lyricsUpdateInterval = setInterval(() => {
            if (!currentLyricsData || !currentTrackInfo) return;
            const currentTime = currentPosition || 0;
            let activeIndex = -1;
            for (let i = 0; i < currentLyricsData.length; i++) {
                if (currentLyricsData[i].time <= currentTime) {
                    activeIndex = i;
                } else {
                    break;
                }
            }
            const lyricsLines = document.querySelectorAll('.lyrics-line');
            lyricsLines.forEach((line, index) => {
                if (index === activeIndex) {
                    line.classList.add('active');
                    line.scrollIntoView({behavior: 'smooth', block: 'center'});
                } else {
                    line.classList.remove('active');
                }
            });
        }, 200);
    }

    function stopLyricsSync() {
        if (lyricsUpdateInterval) {
            clearInterval(lyricsUpdateInterval);
            lyricsUpdateInterval = null;
        }
    }

    function closeLyrics() {
        document.getElementById('lyricsFloating').style.display = 'none';
        stopLyricsSync();
        currentLyricsData = null;
    }

    function initLyricsDrag() {
        const lyricsFloating = document.getElementById('lyricsFloating');
        const header = document.querySelector('.lyrics-header');
        const closeBtn = document.getElementById('lyricsCloseBtn');
        if (!lyricsFloating || !header || !closeBtn) return;

        let isDragging = false;
        let offsetX, offsetY;

        header.addEventListener('mousedown', function (e) {
            if (e.target === closeBtn) return;
            isDragging = true;
            lyricsFloating.classList.add('dragging');
            const rect = lyricsFloating.getBoundingClientRect();
            offsetX = e.clientX - rect.left;
            offsetY = e.clientY - rect.top;
            e.preventDefault();
        });

        document.addEventListener('mousemove', function (e) {
            if (!isDragging) return;
            lyricsFloating.style.left = (e.clientX - offsetX) + 'px';
            lyricsFloating.style.top = (e.clientY - offsetY) + 'px';
            lyricsFloating.style.right = 'auto';
            lyricsFloating.style.bottom = 'auto';
        });

        document.addEventListener('mouseup', function () {
            isDragging = false;
            lyricsFloating.classList.remove('dragging');
        });

        closeBtn.addEventListener('click', closeLyrics);
    }

    function initLyricsButton() {
        const lyricsButton = document.getElementById('lyricsButton');
        if (lyricsButton) {
            lyricsButton.addEventListener('click', showLyrics);
        }
    }

    // ========== 歌词功能结束 ==========

    // 初始化 AI 歌词解析按钮
    function initAiInsightButton() {
        const aiButton = document.getElementById("aiInsightButton");
        const reanalyzeButton = document.getElementById("reanalyzeInsightButton");

        if (aiButton) {
            aiButton.addEventListener("click", function () {
                // 首次点击（或普通点击）调用 fetchTrackInsight(false)，上下文为 'nowPlaying'
                fetchTrackInsight(false, null, 'nowPlaying');
            });
        }

        if (reanalyzeButton) {
            reanalyzeButton.addEventListener("click", function () {
                // 点击“重新分析”调用模型选择器，上下文为 'nowPlaying'
                showModelPicker(null, 'nowPlaying');
            });
        }
    }

    // 初始化统计卡片
    function initStats() {
        fetch("/api/dashboard/stats")
            .then((response) => {
                if (!response.ok) {
                    throw new Error("网络响应错误");
                }
                return response.json();
            })
            .then((data) => {
                document.getElementById("totalPlays").textContent =
                    data.totalPlays.toLocaleString();
                document.getElementById("totalTracks").textContent =
                    data.totalTracks.toLocaleString();
                document.getElementById("totalArtists").textContent =
                    data.totalArtists.toLocaleString();
                document.getElementById("totalAlbums").textContent =
                    data.totalAlbums.toLocaleString();
            })
            .catch((error) => {
                console.error("获取统计数据失败:", error);
                // 显示错误信息
                document.getElementById("totalPlays").textContent = "错误";
                document.getElementById("totalTracks").textContent = "错误";
                document.getElementById("totalArtists").textContent = "错误";
                document.getElementById("totalAlbums").textContent = "错误";
            });
    }

    // 全局变量存储播放来源图表实例
    let sourceChartInstance = null;

    // 未上报记录相关变量
    let currentUnscrobbledPage = 1;
    const unscrobbledPageSize = 10;
    let totalUnscrobbledRecords = 0;

    // 初始化播放来源扇形图
    function initSourceChart() {
        const chartContainer =
            document.getElementById("sourceChart").parentElement;

        // 销毁之前的图表实例（如果存在）
        if (sourceChartInstance) {
            sourceChartInstance.destroy();
            sourceChartInstance = null;
        }

        // 清理容器并重新创建canvas元素
        chartContainer.innerHTML = '<canvas id="sourceChart"></canvas>';
        const canvas = document.getElementById("sourceChart");
        if (!canvas) {
            console.error("找不到ID为sourceChart的canvas元素");
            return;
        }

        const ctx = canvas.getContext("2d");

        // 从后端获取数据
        fetch("/api/dashboard/play-counts-by-source")
            .then((response) => {
                if (!response.ok) {
                    throw new Error("网络响应错误");
                }
                return response.json();
            })
            .then((data) => {
                // 获取暗色模式配置
                const darkModeOptions = getChartDarkModeOptions();

                // 处理数据
                const sources = Object.keys(data);
                const counts = sources.map((source) => data[source]);

                // 定义颜色
                const backgroundColors = [
                    "rgba(231, 76, 60, 0.7)", // Apple Music - 红色
                    "rgba(155, 89, 182, 0.7)", // Audirvana - 紫色
                    "rgba(127, 140, 141, 0.7)", // Roon - 灰色
                    "rgba(52, 152, 219, 0.7)", // 其他 - 蓝色
                ];

                const borderColors = [
                    "rgba(231, 76, 60, 1)",
                    "rgba(155, 89, 182, 1)",
                    "rgba(127, 140, 141, 1)",
                    "rgba(52, 152, 219, 1)",
                ];

                // 创建扇形图并保存实例
                sourceChartInstance = new Chart(ctx, {
                    type: "doughnut",
                    data: {
                        labels: sources,
                        datasets: [
                            {
                                data: counts,
                                backgroundColor: backgroundColors.slice(0, sources.length),
                                borderColor: borderColors.slice(0, sources.length),
                                borderWidth: 1,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: "right",
                                labels: {
                                    color: darkModeOptions.color, // 暗色模式下的图例文字颜色
                                    boxWidth: 12,
                                    padding: 8,
                                    font: {
                                        size: 12,
                                    },
                                },
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const label = context.label || "";
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce(
                                            (a, b) => a + b,
                                            0
                                        );
                                        const percentage = Math.round((value / total) * 100);
                                        return `${label}: ${value} (${percentage}%)`;
                                    },
                                },
                            },
                        },
                        cutout: "60%",
                    },
                });
            })
            .catch((error) => {
                console.error("获取播放来源数据失败:", error);
                // 销毁之前的图表实例（如果存在）
                if (sourceChartInstance) {
                    sourceChartInstance.destroy();
                    sourceChartInstance = null;
                }
                // 显示错误信息
                const chartContainer =
                    document.getElementById("sourceChart").parentElement;
                chartContainer.innerHTML =
                    '<div class="error">加载失败: ' + error.message + "</div>";
            });
    }

    // 全屏元素和状态
    let isTrendChartFullscreen = false;
    let originalChartContainer = null;
    let originalChartParent = null;
    let originalChartStyle = null;

    // 切换趋势图全屏显示
    function toggleTrendChartFullscreen() {
        const chartContainer =
            document.querySelector("#trendChart").parentElement;
        const fullscreenBtn = document.getElementById(
            "trendChartFullscreenBtn"
        );

        if (!isTrendChartFullscreen) {
            // 进入全屏模式
            // 保存原始父元素和样式
            originalChartParent = chartContainer.parentElement;
            originalChartStyle = {
                width: chartContainer.style.width,
                height: chartContainer.style.height,
                position: chartContainer.style.position,
                zIndex: chartContainer.style.zIndex,
            };

            // 创建全屏遮罩
            const fullscreenOverlay = document.createElement("div");
            fullscreenOverlay.id = "trendChartFullscreenOverlay";
            fullscreenOverlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
          `;

            // 创建关闭按钮
            const closeBtn = document.createElement("button");
            closeBtn.innerHTML = "×";
            closeBtn.style.cssText = `
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 36px;
            cursor: pointer;
            z-index: 10001;
          `;

            closeBtn.addEventListener("click", function () {
                toggleTrendChartFullscreen();
            });

            // 创建包含图表的容器
            const chartWrapper = document.createElement("div");
            // 根据当前主题设置背景色
            const isDark = document.body.classList.contains("dark-mode");
            const backgroundColor = isDark ? "#2c2c2c" : "white";
            const textColor = isDark ? "#f0f0f0" : "#2c3e50";
            chartWrapper.style.cssText = `
            width: 90%;
            height: 90%;
            background-color: ${backgroundColor};
            border-radius: 8px;
            padding: 20px;
            color: ${textColor};
          `;

            // 将图表移动到新容器中
            chartContainer.style.width = "100%";
            chartContainer.style.height = "100%";
            chartWrapper.appendChild(chartContainer);
            fullscreenOverlay.appendChild(chartWrapper);
            fullscreenOverlay.appendChild(closeBtn);
            document.body.appendChild(fullscreenOverlay);

            // 更新按钮文本
            fullscreenBtn.textContent = "退出全屏";

            // 标记为全屏状态
            isTrendChartFullscreen = true;

            // 重新渲染图表以适应新尺寸
            if (window.trendChartInstance) {
                window.trendChartInstance.resize();
            }
        } else {
            // 退出全屏模式
            // 移除全屏遮罩
            const fullscreenOverlay = document.getElementById(
                "trendChartFullscreenOverlay"
            );
            if (fullscreenOverlay) {
                // 将图表移回原始位置
                const chartWrapper = fullscreenOverlay.querySelector("div");
                if (chartWrapper) {
                    originalChartParent.appendChild(chartContainer);
                }

                // 恢复原始样式
                chartContainer.style.width = originalChartStyle.width || "";
                chartContainer.style.height = originalChartStyle.height || "";
                chartContainer.style.position = originalChartStyle.position || "";
                chartContainer.style.zIndex = originalChartStyle.zIndex || "";

                // 移除遮罩
                document.body.removeChild(fullscreenOverlay);
            }

            // 更新按钮文本
            fullscreenBtn.textContent = "全屏";

            // 标记为非全屏状态
            isTrendChartFullscreen = false;

            // 重新渲染图表以适应原始尺寸
            if (window.trendChartInstance) {
                window.trendChartInstance.resize();
            }
        }
    }

    // 初始化趋势图
    function initTrendChart(range = 30) {
        const ctx = document.getElementById("trendChart").getContext("2d");

        // 显示加载状态
        const chartContainer =
            document.querySelector("#trendChart").parentElement;
        chartContainer.innerHTML = '<div class="loading">加载中...</div>';

        // 重新创建canvas元素
        const canvas = document.createElement("canvas");
        canvas.id = "trendChart";
        chartContainer.appendChild(canvas);
        const newCtx = canvas.getContext("2d");

        // 从后端获取数据，添加时间范围参数
        fetch(`/api/dashboard/trend?range=${range}`)
            .then((response) => {
                if (!response.ok) {
                    throw new Error("网络响应错误");
                }
                return response.json();
            })
            .then((data) => {
                // 移除加载状态
                const loadingElement = chartContainer.querySelector(".loading");
                if (loadingElement) {
                    loadingElement.remove();
                }

                // 获取暗色模式配置
                const darkModeOptions = getChartDarkModeOptions();

                // 处理新的API响应格式，将数据转换为气泡图所需格式
                const bubbleData = [];
                // 存储每天的总播放次数，用于tooltip显示
                const dailyTotals = {};

                // 遍历hourly数据生成气泡图数据点
                Object.keys(data.hourly).forEach((date) => {
                    const hourlyData = data.hourly[date];
                    // 计算当天总播放次数
                    dailyTotals[date] = hourlyData.total;

                    Object.keys(hourlyData.hourly).forEach((hour) => {
                        const playCount = hourlyData.hourly[hour];
                        // 只有播放次数大于0的数据才显示
                        if (playCount > -1) {
                            // 确保日期格式正确，使用Date构造函数解析日期字符串
                            const dateObj = new Date(date);
                            // 调整到当天的中午12:00，避免时区问题导致的日期偏移
                            dateObj.setHours(12, 0, 0, 0);
                            bubbleData.push({
                                x: dateObj, // 使用Date对象而不是时间戳
                                y: parseInt(hour), // 小时（0-23）
                                r: playCount, // 播放次数作为气泡半径
                                date: date, // 添加原始日期字符串用于tooltip
                            });
                        }
                    });
                });

                // 计算所有数据点中的最大播放次数，用于颜色映射
                let maxPlayCount = 0;
                bubbleData.forEach((point) => {
                    if (point.r > maxPlayCount) {
                        maxPlayCount = point.r;
                    }
                });

                // 颜色插值函数：播放次数多为暖色(红色)，播放次数少为冷色(蓝色)
                function getColorForCount(count, maxCount) {
                    // 归一化值 (0-1)
                    const normalized = maxCount > 0 ? count / maxCount : 0;

                    // 暖色到冷色的渐变
                    // 红色 (255, 0, 0) 到 蓝色 (0, 0, 255)
                    // 反转逻辑：播放次数多显示红色，播放次数少显示蓝色
                    const r = Math.round(255 * normalized);
                    const g = 20;
                    const b = Math.round(255 * (1 - normalized));

                    return {
                        background: `rgba(${r}, ${g}, ${b}, 0.4)`,
                        border: `rgba(${r}, ${g}, ${b}, 1)`,
                    };
                }

                // 保存图表实例以便全屏时重新渲染
                window.trendChartInstance = new Chart(newCtx, {
                    type: "bubble",
                    data: {
                        datasets: [
                            {
                                label: "播放记录",
                                data: bubbleData,
                                backgroundColor: function (context) {
                                    const count = context.raw.r;
                                    return getColorForCount(count, maxPlayCount).background;
                                },
                                borderColor: function (context) {
                                    const count = context.raw.r;
                                    return getColorForCount(count, maxPlayCount).border;
                                },
                                borderWidth: 1,
                                pointStyle: "circle",
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false,
                                labels: {
                                    color: darkModeOptions.color, // 暗色模式下的图例文字颜色
                                },
                            },
                            tooltip: {
                                callbacks: {
                                    title: function (context) {
                                        // 显示日期和时间
                                        const point = context[0].raw;
                                        const date = new Date(point.x);
                                        const dateString = `${date.getFullYear()}-${(
                                            date.getMonth() + 1
                                        )
                                            .toString()
                                            .padStart(2, "0")}-${date
                                            .getDate()
                                            .toString()
                                            .padStart(2, "0")}`;
                                        const dailyTotal = dailyTotals[point.date] || 0;
                                        return `${dateString} ${point.y
                                            .toString()
                                            .padStart(2, "0")}:00 ( 当日总计: ${dailyTotal} )`;
                                    },
                                    label: function (context) {
                                        return `播放次数: ${context.raw.r}`;
                                    },
                                },
                            },
                        },
                        scales: {
                            x: {
                                type: "time",
                                time: {
                                    unit: "day",
                                    tooltipFormat: "yyyy-MM-dd",
                                    displayFormats: {
                                        day: "MM-dd",
                                    },
                                    // 确保时间轴从数据的最小值开始
                                    minUnit: "day",
                                },
                                title: {
                                    display: true,
                                    text: "日期",
                                    color: darkModeOptions.color, // 暗色模式下的标题颜色
                                },
                                grid: {
                                    color: darkModeOptions.gridColor, // 暗色模式下的网格线颜色
                                },
                                ticks: {
                                    color: darkModeOptions.ticksColor, // 暗色模式下的刻度颜色
                                    //stepSize: 1,
                                    maxRotation: 60,
                                    minRotation: 45,
                                    autoSkip: true,
                                    // 确保标签与数据点对齐
                                    source: "data",
                                    // 确保标签与数据点对齐
                                    align: "center",
                                },
                                // 添加边界设置以确保数据点完全显示
                                bounds: "data",
                            },
                            y: {
                                type: "linear",
                                min: -1,
                                max: 24.99,
                                ticks: {
                                    color: darkModeOptions.ticksColor, // 暗色模式下的刻度颜色
                                    stepSize: 1,
                                    maxRotation: 60,
                                    minRotation: 45,
                                    callback: function (value) {
                                        // 显示小时格式 (HH:00)
                                        return `${value.toString().padStart(2, "0")}:00`;
                                    },
                                },
                                title: {
                                    display: true,
                                    text: "时间",
                                    color: darkModeOptions.color, // 暗色模式下的标题颜色
                                },
                                grid: {
                                    color: darkModeOptions.gridColor, // 暗色模式下的网格线颜色
                                },
                            },
                        },
                        elements: {
                            point: {
                                radius: function (context) {
                                    // 根据数据点的 r 值调整半径，添加缩放因子来调整大小
                                    const radius = context.raw.r;
                                    return Math.max(radius * 3, 2); // 最小半径为2
                                },
                            },
                        },
                    },
                });
            })
            .catch((error) => {
                console.error("获取趋势图数据失败:", error);
                // 移除加载状态
                const loadingElement = chartContainer.querySelector(".loading");
                if (loadingElement) {
                    loadingElement.remove();
                }
                // 销毁之前的图表实例（如果存在）
                if (window.trendChartInstance) {
                    window.trendChartInstance.destroy();
                    window.trendChartInstance = null;
                }
                // 确保canvas元素存在后再替换innerHTML
                const canvas = document.getElementById("trendChart");
                if (canvas && canvas.parentElement) {
                    canvas.parentElement.innerHTML =
                        '<div class="error">加载失败: ' + error.message + "</div>";
                }
            });
    }

    // 初始化艺术家图表
    function initArtistChart(type = "plays") {
        const ctx = document.getElementById("artistChart").getContext("2d");

        // 显示加载状态
        const chartContainer =
            document.querySelector("#artistChart").parentElement;
        chartContainer.innerHTML = '<div class="loading">加载中...</div>';

        // 重新创建canvas元素
        const canvas = document.createElement("canvas");
        canvas.id = "artistChart";
        chartContainer.appendChild(canvas);
        const newCtx = canvas.getContext("2d");

        // 根据类型选择不同的API端点
        const apiUrl =
            type === "plays"
                ? "/api/dashboard/top-artists/plays?limit=10"
                : "/api/dashboard/top-artists/tracks?limit=10";

        // 从后端获取数据
        fetch(apiUrl)
            .then((response) => {
                if (!response.ok) {
                    throw new Error("网络响应错误");
                }
                return response.json();
            })
            .then((data) => {
                // 移除加载状态
                const loadingElement = chartContainer.querySelector(".loading");
                if (loadingElement) {
                    loadingElement.remove();
                }

                // 处理数据
                const artists = data.map((item) => item.artist);
                const counts = data.map((item) =>
                    type === "plays" ? item.play_count : item.track_count
                );

                const label = type === "plays" ? "播放次数" : "曲目数";

                // 获取暗色模式配置
                const darkModeOptions = getChartDarkModeOptions();

                new Chart(newCtx, {
                    type: "bar",
                    data: {
                        labels: artists,
                        datasets: [
                            {
                                label: label,
                                data: counts,
                                /* backgroundColor: [
                            "rgba(52, 152, 219, 0.7)",
                            "rgba(46, 204, 113, 0.7)",
                            "rgba(231, 76, 60, 0.7)",
                            "rgba(155, 89, 182, 0.7)",
                            "rgba(241, 196, 15, 0.7)",
                            "rgba(52, 152, 219, 0.7)",
                            "rgba(46, 204, 113, 0.7)",
                            "rgba(231, 76, 60, 0.7)",
                            "rgba(155, 89, 182, 0.7)",
                            "rgba(241, 196, 15, 0.7)",
                          ],
                          borderColor: [
                            "rgba(52, 152, 219, 1)",
                            "rgba(46, 204, 113, 1)",
                            "rgba(231, 76, 60, 1)",
                            "rgba(155, 89, 182, 1)",
                            "rgba(241, 196, 15, 1)",
                            "rgba(52, 152, 219, 1)",
                            "rgba(46, 204, 113, 1)",
                            "rgba(231, 76, 60, 1)",
                            "rgba(155, 89, 182, 1)",
                            "rgba(241, 196, 15, 1)",
                          ], */
                                /* backgroundColor: [
                            "rgba(231, 76, 60, 0.9)", // 1 红
                            "rgba(230, 126, 34, 0.9)", // 2 橙
                            "rgba(241, 196, 15, 0.9)", // 3 黄
                            "rgba(46, 204, 113, 0.85)", // 4 绿
                            "rgba(0, 90, 140, 0.8)", // 5 靛蓝
                            "rgba(52, 152, 219, 0.8)", // 6 蓝
                            "rgba(110, 40, 140, 0.65)", // 7 深紫
                            "rgba(165, 95, 190, 0.7)", // 8 紫
                            "rgba(127, 140, 141, 0.6)", // 9 灰蓝
                            "rgba(189, 195, 199, 0.55)", // 10 浅灰收尾
                          ],
                          borderColor: [
                            "rgba(231, 76, 60, 1)",
                            "rgba(230, 126, 34, 1)",
                            "rgba(241, 196, 15, 1)",
                            "rgba(46, 204, 113, 1)",
                            "rgba(52, 152, 219, 1)",
                            "rgba(52, 73, 94, 1)",
                            "rgba(142, 68, 173, 1)",
                            "rgba(155, 89, 182, 1)",
                            "rgba(127, 140, 141, 1)",
                            "rgba(189, 195, 199, 1)",
                          ], */
                                backgroundColor: [
                                    "rgba(231, 76, 60, 0.9)", // 1 红
                                    "rgba(230, 126, 34, 0.9)", // 2 橙
                                    "rgba(241, 196, 15, 0.9)", // 3 黄
                                    "rgba(46, 204, 113, 0.85)", // 4 绿
                                    "rgba(0, 200, 200, 0.8)", // 5 青
                                    "rgba(52, 152, 219, 0.8)", // 6 蓝
                                    "rgba(0, 90, 140, 0.75)", // 7 深蓝/靛蓝
                                    "rgba(142, 68, 173, 0.7)", // 8 紫
                                    "rgba(127, 140, 141, 0.65)", // 9 灰蓝
                                    "rgba(189, 195, 199, 0.6)", // 10 浅灰收尾
                                ],
                                borderColor: [
                                    "rgba(231, 76, 60, 1)",
                                    "rgba(230, 126, 34, 1)",
                                    "rgba(241, 196, 15, 1)",
                                    "rgba(46, 204, 113, 1)",
                                    "rgba(0, 200, 200, 1)",
                                    "rgba(52, 152, 219, 1)",
                                    "rgba(0, 90, 140, 1)",
                                    "rgba(142, 68, 173, 1)",
                                    "rgba(127, 140, 141, 1)",
                                    "rgba(189, 195, 199, 1)",
                                ],
                                borderWidth: 1,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false,
                                labels: {
                                    color: darkModeOptions.color, // 暗色模式下的图例文字颜色
                                },
                            },
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: darkModeOptions.gridColor, // 暗色模式下的网格线颜色
                                },
                                ticks: {
                                    color: darkModeOptions.ticksColor, // 暗色模式下的刻度颜色
                                },
                            },
                            x: {
                                grid: {
                                    display: false,
                                },
                                ticks: {
                                    color: darkModeOptions.ticksColor, // 暗色模式下的刻度颜色
                                    autoSkip: false,
                                    maxRotation: 45, // 恢复斜体显示
                                    callback: function (value) {
                                        // 截断过长的标签文本
                                        const label = this.getLabelForValue(value);
                                        if (label && label.length > 15) {
                                            return label.substring(0, 15) + "...";
                                        }
                                        return label;
                                    },
                                },
                            },
                        },
                    },
                });
            })
            .catch((error) => {
                console.error("获取艺术家数据失败:", error);
                // 移除加载状态
                const loadingElement = chartContainer.querySelector(".loading");
                if (loadingElement) {
                    loadingElement.remove();
                }
                chartContainer.innerHTML =
                    '<div class="error">加载失败: ' + error.message + "</div>";
            });
    }

    // 初始化热门专辑图表
    function initAlbumChart(days = 7) {
        const ctx = document.getElementById("albumChart").getContext("2d");

        // 显示加载状态
        const chartContainer =
            document.querySelector("#albumChart").parentElement;
        chartContainer.innerHTML = '<div class="loading">加载中...</div>';

        // 重新创建canvas元素
        const canvas = document.createElement("canvas");
        canvas.id = "albumChart";
        chartContainer.appendChild(canvas);
        const newCtx = canvas.getContext("2d");

        // 从后端获取数据
        fetch(`/api/dashboard/top-albums?days=${days}&limit=10`)
            .then((response) => {
                if (!response.ok) {
                    throw new Error("网络响应错误");
                }
                return response.json();
            })
            .then((data) => {
                // 移除加载状态
                const loadingElement = chartContainer.querySelector(".loading");
                if (loadingElement) {
                    loadingElement.remove();
                }

                // 处理数据
                const albums = data.map((item) => item.album);
                const artists = data.map((item) => item.artist);
                const counts = data.map((item) => item.play_count);

                // 获取暗色模式配置
                const darkModeOptions = getChartDarkModeOptions();

                new Chart(newCtx, {
                    type: "bar",
                    data: {
                        labels: albums,
                        datasets: [
                            {
                                label: "播放次数",
                                data: counts,
                                backgroundColor: [
                                    "rgba(231, 76, 60, 0.9)", // 1 红
                                    "rgba(230, 126, 34, 0.9)", // 2 橙
                                    "rgba(241, 196, 15, 0.9)", // 3 黄
                                    "rgba(46, 204, 113, 0.85)", // 4 绿
                                    "rgba(0, 200, 200, 0.8)", // 5 青
                                    "rgba(52, 152, 219, 0.8)", // 6 蓝
                                    "rgba(0, 90, 140, 0.75)", // 7 深蓝/靛蓝
                                    "rgba(142, 68, 173, 0.7)", // 8 紫
                                    "rgba(127, 140, 141, 0.65)", // 9 灰蓝
                                    "rgba(189, 195, 199, 0.6)", // 10 浅灰收尾
                                ],
                                borderColor: [
                                    "rgba(231, 76, 60, 1)",
                                    "rgba(230, 126, 34, 1)",
                                    "rgba(241, 196, 15, 1)",
                                    "rgba(46, 204, 113, 1)",
                                    "rgba(0, 200, 200, 1)",
                                    "rgba(52, 152, 219, 1)",
                                    "rgba(0, 90, 140, 1)",
                                    "rgba(142, 68, 173, 1)",
                                    "rgba(127, 140, 141, 1)",
                                    "rgba(189, 195, 199, 1)",
                                ],
                                borderWidth: 1,
                            },
                        ],
                    },
                    options: {
                        indexAxis: "y", // 👈 水平条形图
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false,
                                labels: {
                                    color: darkModeOptions.color, // 暗色模式下的图例文字颜色
                                },
                            },
                            tooltip: {
                                callbacks: {
                                    // 移除默认 label（第一行）
                                    /*   label: function () {
                              return null;
                            }, */
                                    // 用 title 回调显示专辑名（第一行）
                                    title: function (ctx) {
                                        const index = ctx[0].dataIndex; // tooltipItems 数组的第 0 个元素
                                        const artist = artists[index]; // 拿到对应作者
                                        return "《" + ctx[0].label + `》- ${artist}`; // 专辑名
                                    },
                                    // 用 afterLabel 回调显示作者 + 播放次数（第二行）
                                    /* afterLabel: function (ctx) {
                              const artist = artists[ctx.dataIndex];
                              //const count = counts[ctx.dataIndex];
                              return `${artist}`;
                            }, */
                                },
                            },
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                grid: {
                                    color: darkModeOptions.gridColor, // 暗色模式下的网格线颜色
                                },
                                ticks: {
                                    color: darkModeOptions.ticksColor, // 暗色模式下的刻度颜色
                                },
                            },
                            y: {
                                grid: {display: false},
                                ticks: {
                                    color: darkModeOptions.ticksColor, // 暗色模式下的刻度颜色
                                    autoSkip: false,
                                    //maxRotation: 60, // 恢复斜体显示
                                    //minRotation: 45, // 恢复斜体显示
                                    callback: function (value) {
                                        const label = this.getLabelForValue(value);
                                        if (label && label.length > 15) {
                                            return label.substring(0, 15) + "...";
                                        }
                                        return label;
                                    },
                                },
                            },
                        },
                    },
                });
            })
            .catch((error) => {
                console.error("获取专辑数据失败:", error);
                // 移除加载状态
                const loadingElement = chartContainer.querySelector(".loading");
                if (loadingElement) {
                    loadingElement.remove();
                }
                chartContainer.innerHTML =
                    '<div class="error">加载失败: ' + error.message + "</div>";
            });
    }

    // 全屏元素和状态 - 口味流派图表
    let isGenreChartFullscreen = false;
    let originalGenreChartContainer = null;
    let originalGenreChartParent = null;
    let originalGenreChartStyle = null;

    // 切换口味流派图表全屏显示
    function toggleGenreChartFullscreen() {
        const chartContainer =
            document.querySelector("#genreChart").parentElement;
        const fullscreenBtn = document.getElementById(
            "genreChartFullscreenBtn"
        );

        if (!isGenreChartFullscreen) {
            // 进入全屏模式
            // 保存原始父元素和样式
            originalGenreChartParent = chartContainer.parentElement;
            originalGenreChartStyle = {
                width: chartContainer.style.width,
                height: chartContainer.style.height,
                position: chartContainer.style.position,
                zIndex: chartContainer.style.zIndex,
            };

            // 创建全屏遮罩
            const fullscreenOverlay = document.createElement("div");
            fullscreenOverlay.id = "genreChartFullscreenOverlay";
            fullscreenOverlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
          `;

            // 创建关闭按钮
            const closeBtn = document.createElement("button");
            closeBtn.innerHTML = "×";
            closeBtn.style.cssText = `
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 36px;
            cursor: pointer;
            z-index: 10001;
          `;

            closeBtn.addEventListener("click", function () {
                toggleGenreChartFullscreen();
            });

            // 创建包含图表的容器
            const chartWrapper = document.createElement("div");
            // 根据当前主题设置背景色
            const isDark = document.body.classList.contains("dark-mode");
            const backgroundColor = isDark ? "#2c2c2c" : "white";
            const textColor = isDark ? "#f0f0f0" : "#2c3e50";
            chartWrapper.style.cssText = `
            width: 90%;
            height: 90%;
            background-color: ${backgroundColor};
            border-radius: 8px;
            padding: 20px;
            color: ${textColor};
          `;

            // 将图表移动到新容器中
            chartContainer.style.width = "100%";
            chartContainer.style.height = "100%";
            chartWrapper.appendChild(chartContainer);
            fullscreenOverlay.appendChild(chartWrapper);
            fullscreenOverlay.appendChild(closeBtn);
            document.body.appendChild(fullscreenOverlay);

            // 更新按钮文本
            fullscreenBtn.textContent = "退出全屏";

            // 标记为全屏状态
            isGenreChartFullscreen = true;

            // 重新渲染图表以适应新尺寸
            if (window.genreChartInstance) {
                window.genreChartInstance.resize();
            }
        } else {
            // 退出全屏模式
            // 移除全屏遮罩
            const fullscreenOverlay = document.getElementById(
                "genreChartFullscreenOverlay"
            );
            if (fullscreenOverlay) {
                // 将图表移回原始位置
                const chartWrapper = fullscreenOverlay.querySelector("div");
                if (chartWrapper) {
                    originalGenreChartParent.appendChild(chartContainer);
                }

                // 恢复原始样式
                chartContainer.style.width = originalGenreChartStyle.width || "";
                chartContainer.style.height = originalGenreChartStyle.height || "";
                chartContainer.style.position =
                    originalGenreChartStyle.position || "";
                chartContainer.style.zIndex = originalGenreChartStyle.zIndex || "";

                // 移除遮罩
                document.body.removeChild(fullscreenOverlay);
            }

            // 更新按钮文本
            fullscreenBtn.textContent = "全屏";

            // 标记为非全屏状态
            isGenreChartFullscreen = false;

            // 重新渲染图表以适应原始尺寸
            if (window.genreChartInstance) {
                window.genreChartInstance.resize();
            }
        }
    }

    // 初始化热门流派图表
    function initGenreChart() {
        const ctx = document.getElementById("genreChart").getContext("2d");

        // 显示加载状态
        const chartContainer =
            document.querySelector("#genreChart").parentElement;
        chartContainer.innerHTML = '<div class="loading">加载中...</div>';

        // 重新创建canvas元素
        const canvas = document.createElement("canvas");
        canvas.id = "genreChart";
        chartContainer.appendChild(canvas);
        const newCtx = canvas.getContext("2d");

        // 从后端获取数据
        fetch("/api/dashboard/top-genres?limit=10")
            .then((response) => {
                if (!response.ok) {
                    throw new Error("网络响应错误");
                }
                return response.json();
            })
            .then((data) => {
                // 移除加载状态
                const loadingElement = chartContainer.querySelector(".loading");
                if (loadingElement) {
                    loadingElement.remove();
                }

                // 处理数据
                const genres = data.map((item) => item.track_genre_name);
                const genresNameZhs = data.map((item) => item.genre_name_zh);
                const counts = data.map((item) => item.track_genre_count);

                // 定义颜色
                const backgroundColors = [
                    "rgba(231, 76, 60, 0.8)", // 红
                    "rgba(230, 126, 34, 0.8)", // 橙
                    "rgba(241, 196, 15, 0.8)", // 黄
                    "rgba(46, 204, 113, 0.8)", // 绿
                    "rgba(0, 200, 200, 0.8)", // 青
                    "rgba(52, 152, 219, 0.8)", // 蓝
                    "rgba(0, 90, 140, 0.8)", // 深蓝
                    "rgba(142, 68, 173, 0.8)", // 紫
                    "rgba(127, 140, 141, 0.8)", // 灰
                    "rgba(189, 195, 199, 0.8)", // 浅灰
                ];

                const borderColors = [
                    "rgba(231, 76, 60, 1)",
                    "rgba(230, 126, 34, 1)",
                    "rgba(241, 196, 15, 1)",
                    "rgba(46, 204, 113, 1)",
                    "rgba(0, 200, 200, 1)",
                    "rgba(52, 152, 219, 1)",
                    "rgba(0, 90, 140, 1)",
                    "rgba(142, 68, 173, 1)",
                    "rgba(127, 140, 141, 1)",
                    "rgba(189, 195, 199, 1)",
                ];

                // 原始数据
                let dataset = genres.map((g, i) => ({
                    genre: g,
                    count: counts[i],
                    bg: backgroundColors[i],
                    border: borderColors[i],
                    zh: genresNameZhs[i],
                }));

                // Fisher-Yates 洗牌算法随机打乱
                for (let i = dataset.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [dataset[i], dataset[j]] = [dataset[j], dataset[i]];
                }

                // 拆分回数组
                const shuffledGenres = dataset.map((item) => item.genre);
                const shuffledCounts = dataset.map((item) => item.count);
                const shuffledBackgroundColors = dataset.map((item) => item.bg);
                const shuffledBorderColors = dataset.map((item) => item.border);
                const shuffledGenresNameZhs = dataset.map((item) => item.zh);

                // 获取暗色模式配置
                const darkModeOptions = getChartDarkModeOptions();

                // 保存图表实例以便全屏时重新渲染
                window.genreChartInstance = new Chart(newCtx, {
                    type: "polarArea",
                    data: {
                        labels: shuffledGenres,
                        datasets: [
                            {
                                label: "播放次数",
                                data: shuffledCounts,
                                backgroundColor: shuffledBackgroundColors,
                                borderColor: shuffledBorderColors,
                                borderWidth: 1,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: "left",
                                labels: {
                                    color: darkModeOptions.color, // 暗色模式下的图例文字颜色
                                    font: {
                                        size: 10, // 字体变小
                                    },
                                    boxWidth: 9, // 小方块变小
                                    padding: 6, // legend 项之间的间距缩小
                                },
                            },
                            tooltip: {
                                callbacks: {
                                    title: function (ctx) {
                                        const index = ctx[0].dataIndex;
                                        const genre_name_zh = shuffledGenresNameZhs[index];
                                        return ctx[0].label + `（ ${genre_name_zh} ）`;
                                    },
                                },
                            },
                        },
                        scales: {
                            r: {
                                pointLabels: {
                                    color: darkModeOptions.color, // 暗色模式下的点标签颜色
                                    display: true,
                                    centerPointLabels: true,
                                    font: {
                                        size: 8,
                                    },
                                },
                                ticks: {
                                    color: darkModeOptions.ticksColor, // 暗色模式下的刻度颜色
                                    backdropColor: isDarkMode()
                                        ? "rgba(44, 44, 44, 0.8)"
                                        : "rgba(0, 0, 0, 0.05)",
                                },
                                // max: Math.max(...shuffledCounts) * 1.1, // 扩大 20% 半径
                            },
                        },
                    },
                });
            })
            .catch((error) => {
                console.error("获取流派数据失败:", error);
                // 移除加载状态
                const loadingElement = chartContainer.querySelector(".loading");
                if (loadingElement) {
                    loadingElement.remove();
                }
                // 销毁之前的图表实例（如果存在）
                if (window.genreChartInstance) {
                    window.genreChartInstance.destroy();
                    window.genreChartInstance = null;
                }
                // 确保canvas元素存在后再替换innerHTML
                const canvas = document.getElementById("genreChart");
                if (canvas && canvas.parentElement) {
                    canvas.parentElement.innerHTML =
                        '<div class="error">加载失败: ' + error.message + "</div>";
                }
            });
    }

    // 初始化最近播放列表
    function initRecentPlays() {
        const recentPlaysList = document.getElementById("recentPlaysList");
        recentPlaysList.innerHTML = '<div class="loading">加载中...</div>';

        fetch("/api/recent-plays?limit=10")
            .then((response) => {
                if (!response.ok) {
                    throw new Error("网络响应错误");
                }
                return response.json();
            })
            .then((data) => {
                // 移除加载状态
                const loadingElement = recentPlaysList.querySelector(".loading");
                if (loadingElement) {
                    loadingElement.remove();
                }

                if (data.length === 0) {
                    recentPlaysList.innerHTML = '<div class="loading">暂无数据</div>';
                    return;
                }

                data.forEach((item, index) => {
                    const rankingItem = document.createElement("li");
                    rankingItem.className = "ranking-item";

                    const playTime = new Date(item.play_time);
                    const timeString = playTime.toLocaleTimeString("zh-CN", {
                        hour: "2-digit",
                        minute: "2-digit",
                        second: "2-digit",
                    });

                    // 根据来源设置样式
                    let sourceClass = "";
                    let sourceText = "";
                    switch (item.source?.toLowerCase()) {
                        case "apple music":
                            sourceClass = "source-applemusic";
                            sourceText = "AppleMusic";
                            break;
                        case "audirvana":
                        case "au":
                            sourceClass = "source-audirvana";
                            sourceText = "Audirvana";
                            break;
                        case "roon":
                            sourceClass = "source-roon";
                            sourceText = "Roon";
                            break;
                        default:
                            sourceClass = "";
                            sourceText = item.source || "Unknown";
                    }

                    rankingItem.innerHTML = `
                                  <div class="rank-number rank-other">${
                        index + 1
                    }</div>
                                  <div class="track-info">
                                      <div class="track-title">${
                        item.track
                    }</div>
                                      <div class="track-artist">${
                        item.artist
                    } - ${item.album}</div>
                                  </div>
                                  <div style="display: flex; flex-direction: column; align-items: flex-end; margin-left: 10px;">
                                    <div class="play-source ${sourceClass}">${sourceText}</div>
                                    <div class="play-count">${timeString}</div>
                                  </div>
                              `;

                    // 添加点击事件处理
                    rankingItem.addEventListener('click', function () {
                        showTrackDetails(item.artist, item.album, item.track);
                    });
                    rankingItem.style.cursor = 'pointer';

                    recentPlaysList.appendChild(rankingItem);
                });

                // 调整两个列表的高度
                adjustRankingListsHeight();
            })
            .catch((error) => {
                console.error("获取最近播放数据失败:", error);
                // 移除加载状态
                const loadingElement = recentPlaysList.querySelector(".loading");
                if (loadingElement) {
                    loadingElement.remove();
                }
                recentPlaysList.innerHTML =
                    '<div class="error">加载失败: ' + error.message + "</div>";
            });
    }

    // 定期刷新最近播放列表
    function refreshRecentPlays() {
        const recentPlaysList = document.getElementById("recentPlaysList");

        fetch("/api/recent-plays?limit=10")
            .then((response) => {
                if (!response.ok) {
                    throw new Error("网络响应错误");
                }
                return response.json();
            })
            .then((data) => {
                recentPlaysList.innerHTML = "";

                if (data.length === 0) {
                    recentPlaysList.innerHTML = '<div class="loading">暂无数据</div>';
                    return;
                }

                data.forEach((item, index) => {
                    const rankingItem = document.createElement("li");
                    rankingItem.className = "ranking-item";

                    const playTime = new Date(item.play_time);
                    const timeString = playTime.toLocaleTimeString("zh-CN", {
                        hour: "2-digit",
                        minute: "2-digit",
                        second: "2-digit",
                    });

                    // 根据来源设置样式
                    let sourceClass = "";
                    let sourceText = "";
                    switch (item.source?.toLowerCase()) {
                        case "apple music":
                            sourceClass = "source-applemusic";
                            sourceText = "AppleMusic";
                            break;
                        case "audirvana":
                        case "au":
                            sourceClass = "source-audirvana";
                            sourceText = "Audirvana";
                            break;
                        case "roon":
                            sourceClass = "source-roon";
                            sourceText = "Roon";
                            break;
                        default:
                            sourceClass = "";
                            sourceText = item.source || "Unknown";
                    }

                    rankingItem.innerHTML = `
                                  <div class="rank-number rank-other">${
                        index + 1
                    }</div>
                                  <div class="track-info">
                                      <div class="track-title">${
                        item.track
                    }</div>
                                      <div class="track-artist">${
                        item.artist
                    } - ${item.album}</div>
                                  </div>
                                  <div style="display: flex; flex-direction: column; align-items: flex-end; margin-left: 10px;">
                                    <div class="play-source ${sourceClass}">${sourceText}</div>
                                    <div class="play-count">${timeString}</div>
                                  </div>
                              `;

                    // 添加点击事件处理
                    rankingItem.addEventListener('click', function () {
                        showTrackDetails(item.artist, item.album, item.track);
                    });
                    rankingItem.style.cursor = 'pointer';

                    recentPlaysList.appendChild(rankingItem);
                });

                // 调整两个列表的高度
                adjustRankingListsHeight();
            })
            .catch((error) => {
                console.error("刷新最近播放数据失败:", error);
            });
    }

    // 初始化排行榜
    function initRanking(rankingType = "all", keyword = "") {
        currentRankingType = rankingType;
        rankingSearchKeyword = keyword;
        
        const rankingList = document.getElementById("rankingList");
        rankingList.innerHTML = '<div class="loading">加载中...</div>';

        // 根据排名类型调整API请求
        let apiUrl = `/api/track-play-counts?limit=10&offset=0${keyword ? '&keyword=' + encodeURIComponent(keyword) : ''}`;
        if (rankingType === "month") {
            // 月排行榜
            apiUrl = `/api/track-play-counts/period?limit=10&offset=0&period=month${keyword ? '&keyword=' + encodeURIComponent(keyword) : ''}`;
        } else if (rankingType === "week") {
            // 周排行榜
            apiUrl = `/api/track-play-counts/period?limit=10&offset=0&period=week${keyword ? '&keyword=' + encodeURIComponent(keyword) : ''}`;
        }

        fetch(apiUrl)
            .then((response) => {
                if (!response.ok) {
                    throw new Error("网络响应错误");
                }
                return response.json();
            })
            .then((data) => {
                // 移除加载状态
                const loadingElement = rankingList.querySelector(".loading");
                if (loadingElement) {
                    loadingElement.remove();
                }

                if (data.length === 0) {
                    rankingList.innerHTML = '<div class="loading">暂无数据</div>';
                    return;
                }

                data.forEach((item, index) => {
                    const rankingItem = document.createElement("li");
                    rankingItem.className = "ranking-item";

                    const rank = index + 1;
                    let rankClass = "rank-other";
                    if (rank === 1) rankClass = "rank-1";
                    else if (rank === 2) rankClass = "rank-2";
                    else if (rank === 3) rankClass = "rank-3";

                    rankingItem.innerHTML = `
                                  <div class="rank-number ${rankClass}">${rank}</div>
                                  <div class="track-info">
                                      <div class="track-title">${item.track}</div>
                                      <div class="track-artist">${item.artist} - ${item.album}</div>
                                  </div>
                                  <div class="play-count">${item.play_count} 次</div>
                              `;

                    // 添加点击事件处理
                    rankingItem.addEventListener('click', function () {
                        showTrackDetails(item.artist, item.album, item.track);
                    });
                    rankingItem.style.cursor = 'pointer';

                    rankingList.appendChild(rankingItem);
                });

                // 调整两个列表的高度
                adjustRankingListsHeight();
            })
            .catch((error) => {
                console.error("获取排行榜数据失败:", error);
                // 移除加载状态
                const loadingElement = rankingList.querySelector(".loading");
                if (loadingElement) {
                    loadingElement.remove();
                }
                rankingList.innerHTML =
                    '<div class="error">加载失败: ' + error.message + "</div>";
            });
    }

    // 调整排行榜列表高度，使两个卡片保持一致
    function adjustRankingListsHeight() {
        const recentPlaysList = document.getElementById("recentPlaysList");
        const rankingList = document.getElementById("rankingList");

        // 重置高度
        recentPlaysList.style.height = "auto";
        rankingList.style.height = "auto";

        // 获取两个列表的最大高度
        const recentPlaysHeight = recentPlaysList.offsetHeight;
        const rankingHeight = rankingList.offsetHeight;
        const maxHeight = Math.max(recentPlaysHeight, rankingHeight);

        // 设置两个列表的高度为最大高度
        if (maxHeight > 0) {
            // 只在需要时设置固定高度，避免影响布局
            if (recentPlaysHeight !== rankingHeight) {
                recentPlaysList.style.height = maxHeight + "px";
                rankingList.style.height = maxHeight + "px";
            }
        }
    }

    // 加载未上报记录
    function loadUnscrobbledRecords() {
        const content = document.getElementById("unscrobbledContent");
        content.innerHTML = '<div class="loading">加载中...</div>';

        const offset = (currentUnscrobbledPage - 1) * unscrobbledPageSize;

        // 获取未上报记录总数
        fetch("/api/unscrobbled-records/count")
            .then((response) => {
                if (!response.ok) {
                    throw new Error("网络响应错误");
                }
                return response.json();
            })
            .then((data) => {
                totalUnscrobbledRecords = data.count;
                updatePagination();
            })
            .catch((error) => {
                console.error("获取未上报记录总数失败:", error);
            });

        // 获取未上报记录
        fetch(
            `/api/unscrobbled-records?limit=${unscrobbledPageSize}&offset=${offset}`
        )
            .then((response) => {
                if (!response.ok) {
                    throw new Error("网络响应错误");
                }
                return response.json();
            })
            .then((data) => {
                renderUnscrobbledRecords(data);
            })
            .catch((error) => {
                console.error("获取未上报记录失败:", error);
                content.innerHTML =
                    '<div class="error">加载失败: ' + error.message + "</div>";
            });
    }

    // 渲染未上报记录
    function renderUnscrobbledRecords(records) {
        const content = document.getElementById("unscrobbledContent");

        if (records.length === 0) {
            content.innerHTML = '<div class="loading">暂无未上报记录</div>';
            return;
        }

        // 检查是否处于暗色模式
        const isDark = document.body.classList.contains("dark-mode");

        // 根据主题设置颜色
        const headerBgColor = isDark ? "#3a3a3a" : "#f1f3f9";
        const borderColor = isDark ? "#444444" : "#e9ecef";
        const rowBorderColor = isDark ? "#444444" : "#e9ecef";
        const textColor = isDark ? "#f0f0f0" : "#2c3e50";

        let html = `<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; color: ${textColor};">`;
        html += `<thead><tr style="background-color: ${headerBgColor}; text-align: left;">`;
        html += `<th style="padding: 12px; border-bottom: 2px solid ${borderColor};"></th>`;
        html += `<th style="padding: 12px; border-bottom: 2px solid ${borderColor};">曲目</th>`;
        html += `<th style="padding: 12px; border-bottom: 2px solid ${borderColor};">艺术家</th>`;
        html += `<th style="padding: 12px; border-bottom: 2px solid ${borderColor};">专辑</th>`;
        html += `<th style="padding: 12px; border-bottom: 2px solid ${borderColor};">播放时间</th>`;
        html += `<th style="padding: 12px; border-bottom: 2px solid ${borderColor};">来源</th>`;
        html += "</tr></thead><tbody>";

        records.forEach((record) => {
            const playTime = new Date(record.play_time);
            const timeString = playTime.toLocaleString("zh-CN");

            // 根据来源设置样式
            let sourceClass = "";
            let sourceText = "";
            switch (record.source?.toLowerCase()) {
                case "apple music":
                    sourceClass = "source-applemusic";
                    sourceText = "AppleMusic";
                    break;
                case "audirvana":
                case "au":
                    sourceClass = "source-audirvana";
                    sourceText = "Audirvana";
                    break;
                case "roon":
                    sourceClass = "source-roon";
                    sourceText = "Roon";
                    break;
                default:
                    sourceClass = "";
                    sourceText = record.source || "Unknown";
            }

            html += `<tr style="border-bottom: 1px solid ${rowBorderColor};">`;
            html += `<td style="padding: 12px;"><input type="checkbox" class="record-checkbox" data-id="${record.id}"></td>`;
            html += `<td style="padding: 12px;">${record.track}</td>`;
            html += `<td style="padding: 12px;">${record.artist}</td>`;
            html += `<td style="padding: 12px;">${record.album}</td>`;
            html += `<td style="padding: 12px;">${timeString}</td>`;
            html += `<td style="padding: 12px;"><div class="play-source ${sourceClass}" style="display: inline-block;">${sourceText}</div></td>`;
            html += "</tr>";
        });

        html += "</tbody></table></div>";
        content.innerHTML = html;
    }

    // 更新分页信息
    function updatePagination() {
        const totalPages = Math.ceil(
            totalUnscrobbledRecords / unscrobbledPageSize
        );
        const pageInfo = document.getElementById("pageInfo");
        const prevBtn = document.getElementById("prevPage");
        const nextBtn = document.getElementById("nextPage");

        // 检查是否处于暗色模式
        const isDark = document.body.classList.contains("dark-mode");

        // 设置分页信息文本颜色
        if (pageInfo) {
            pageInfo.style.color = isDark ? "var(--text-primary)" : "#2c3e50";
        }

        if (totalUnscrobbledRecords === 0) {
            pageInfo.textContent = "无记录";
            prevBtn.disabled = true;
            nextBtn.disabled = true;
            return;
        }

        pageInfo.textContent = `第 ${currentUnscrobbledPage} 页，共 ${totalPages} 页 (${totalUnscrobbledRecords} 条记录)`;
        prevBtn.disabled = currentUnscrobbledPage === 1;
        nextBtn.disabled = currentUnscrobbledPage === totalPages;
    }

    // 同步选中的记录
    function syncSelectedRecords() {
        const checkboxes = document.querySelectorAll(
            ".record-checkbox:checked"
        );
        if (checkboxes.length === 0) {
            alert("请先选择要同步的记录");
            return;
        }

        const ids = Array.from(checkboxes).map((cb) => parseInt(cb.dataset.id));

        // 禁用按钮并显示加载状态
        const syncBtn = document.getElementById("syncSelectedBtn");
        const originalText = syncBtn.textContent;
        syncBtn.textContent = "同步中...";
        syncBtn.disabled = true;

        fetch("/api/unscrobbled-records/sync", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ids: ids}),
        })
            .then((response) => {
                if (!response.ok) {
                    throw new Error("网络响应错误");
                }
                return response.json();
            })
            .then((data) => {
                if (data.failed_count > 0) {
                    alert(
                        `同步完成: ${data.success_count} 条记录同步成功, ${data.failed_count} 条记录同步失败`
                    );
                    // 显示失败的记录
                    if (data.failed_records && data.failed_records.length > 0) {
                        let failedList = "同步失败的记录:\n";
                        data.failed_records.forEach((record) => {
                            failedList += `- ${record.track} - ${record.artist}\n`;
                        });
                        console.log(failedList);
                    }
                } else {
                    alert(`同步完成: ${data.success_count} 条记录同步成功`);
                }

                // 重新加载未上报记录
                loadUnscrobbledRecords();
            })
            .catch((error) => {
                console.error("同步记录失败:", error);
                alert("同步记录失败: " + error.message);
            })
            .finally(() => {
                // 恢复按钮状态
                syncBtn.textContent = originalText;
                syncBtn.disabled = false;
            });
    }

    // --- 音眸列表相关 JS 逻辑 ---

    // 加载音眸解析列表
    async function loadInsightList() {
        const content = document.getElementById("insightListContent");
        content.innerHTML = '<div class="loading">加载中...</div>';
        
        // 实时从输入框获取最新关键词，确保刷新按钮点击时也能带上
        const searchInput = document.getElementById("insightSearchInput");
        if (searchInput) {
            currentInsightKeyword = searchInput.value.trim();
        }

        try {
            const offset = (currentInsightPage - 1) * insightPageSize;
            const url = `/api/insights/all?limit=${insightPageSize}&offset=${offset}&keyword=${encodeURIComponent(currentInsightKeyword)}`;
            const response = await fetch(url);
            const data = await response.json();
            
            totalInsights = data.total;
            renderInsightList(data.insights || []);
            updateInsightPagination();
        } catch (error) {
            console.error("加载音眸列表失败:", error);
            content.innerHTML = `<div class="error">加载失败: ${error.message}</div>`;
        }
    }

    // 渲染音眸列表
    function renderInsightList(insights) {
        const content = document.getElementById("insightListContent");
        if (insights.length === 0) {
            content.innerHTML = '<div class="loading">暂无解析记录</div>';
            return;
        }

        const isDark = isDarkMode();
        const headerBgColor = isDark ? "#3a3a3a" : "#f1f3f9";
        const borderColor = isDark ? "#444444" : "#e9ecef";
        const textColor = isDark ? "#f0f0f0" : "#2c3e50";

        let html = `<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; color: ${textColor};">`;
        html += `<thead style="background-color: ${headerBgColor}; position: sticky; top: 0; z-index: 10;"><tr>`;
        html += `<th style="padding: 12px; border-bottom: 2px solid ${borderColor};">艺术家 / 曲目</th>`;
        html += `<th style="padding: 12px; border-bottom: 2px solid ${borderColor};">模型</th>`;
        html += `<th style="padding: 12px; border-bottom: 2px solid ${borderColor};">创建于</th>`;
        html += `<th style="padding: 12px; border-bottom: 2px solid ${borderColor}; text-align: center;">状态</th>`;
        html += `<th style="padding: 12px; border-bottom: 2px solid ${borderColor}; text-align: center;">操作</th>`;
        html += "</tr></thead><tbody>";

        insights.forEach(ins => {
            const time = new Date(ins.created_at).toLocaleString("zh-CN");
            const statusText = ins.is_disabled ? "已禁用" : "已启用";
            const statusClass = ins.is_disabled ? "negative" : "positive";
            const toggleText = ins.is_disabled ? "启用" : "禁用";

            html += `<tr style="border-bottom: 1px solid ${borderColor};">`;
            html += `<td style="padding: 12px;">
                        <div style="font-weight: bold;">${ins.artist}</div>
                        <div style="font-size: 0.85em; opacity: 0.8;">${ins.track}</div>
                     </td>`;
            html += `<td style="padding: 12px;">${ins.llm_provider || '-'}</td>`;
            html += `<td style="padding: 12px;">${time}</td>`;
            html += `<td style="padding: 12px; text-align: center;">
                        <span class="stat-change ${statusClass}" style="float:none; padding: 2px 8px; border-radius: 4px;">${statusText}</span>
                     </td>`;
            html += `<td style="padding: 12px; text-align: center;">
                        <div style="display: flex; gap: 8px; justify-content: center;">
                            <button class="time-filter" onclick="toggleInsightStatus(${ins.id})" style="padding: 4px 10px;">${toggleText}</button>
                            <button class="time-filter" onclick="showInsightDetailsById(${ins.id})" style="padding: 4px 10px;">详情</button>
                            <button class="time-filter" onclick="showInsightCallLogs(${ins.id}, '${ins.artist.replace(/'/g, "\\'")}', '${ins.track.replace(/'/g, "\\'")}')" style="padding: 4px 10px;">流水</button>
                            <button class="time-filter" onclick="deleteInsight(${ins.id})" style="padding: 4px 10px; background-color: #e74c3c; color: white; border-color: #e74c3c;">删除</button>
                        </div>
                     </td>`;
            html += "</tr>";
        });

        html += "</tbody></table></div>";
        content.innerHTML = html;
    }

    // 更新音眸列表分页
    function updateInsightPagination() {
        const totalPages = Math.ceil(totalInsights / insightPageSize);
        const info = document.getElementById("insightPageInfo");
        info.textContent = `第 ${currentInsightPage} 页 / 共 ${totalPages} 页 (${totalInsights} 条)`;
        document.getElementById("insightPrevPage").disabled = currentInsightPage === 1;
        document.getElementById("insightNextPage").disabled = currentInsightPage >= totalPages;
    }

    // 切换禁用/启用状态
    async function toggleInsightStatus(id) {
        try {
            const res = await fetch(`/api/insights/${id}/toggle-status`, { method: 'POST' });
            if (res.ok) loadInsightList();
            else alert("操作失败");
        } catch (e) {
            console.error(e);
            alert("切换状态出错");
        }
    }





    // 展示详情（从列表点击，使用 list 上下文）
    async function showInsightDetailsById(id) {
        const contextType = 'list';
        try {
            // 首先切换到“解析详情”页签并展示 Loading
            showModal(`${contextType}InsightModal`);
            switchInsightTab('summary', contextType);
            
            const streamContent = document.getElementById(`${contextType}-aiInsightStreamContent`);
            if (streamContent) streamContent.innerHTML = '<div class="loading">加载中...</div>';
            
            const footer = document.getElementById(`${contextType}-aiActionFooter`);
            if (footer) footer.style.display = "none";

            const response = await fetch(`/api/insights/all?limit=1000&offset=0`);
            const data = await response.json();
            const insight = data.insights.find(ins => ins.id === id);
            
            if (!insight) return alert("未找到记录");

            // 更新上下文状态
            insightStates[contextType].insight = insight;
            insightStates[contextType].trackInfo = {
                artist: insight.artist,
                album: insight.album,
                title: insight.track
            };
            currentTrackInsight = insight;
            
            // 渲染主要解析内容
            renderInsight(insight, contextType);
            
            // 显示底部操作栏
            if (footer) footer.style.display = "flex";
            
        } catch (e) {
            console.error(e);
            alert("加载详情失败");
        }
    }

    // 删除解析记录
    async function deleteInsight(id) {
        if (!confirm("确定要永久删除这条解析记录吗？此操作不可撤销。")) return;
        
        try {
            const res = await fetch(`/api/insights/${id}`, { method: 'DELETE' });
            if (res.ok) {
                loadInsightList();
            } else {
                const data = await res.json();
                alert("删除失败: " + (data.error || "未知错误"));
            }
        } catch (e) {
            console.error(e);
            alert("删除记录出错");
        }
    }

    // 展示流水日志
    async function showInsightCallLogs(id, artist, track) {
        const modal = document.getElementById("callLogModal");
        const content = document.getElementById("callLogContent");
        document.getElementById("callLogTitle").textContent = `流水日志: ${artist} - ${track}`;
        
        showModal("callLogModal");
        content.innerHTML = '<div class="loading">加载中...</div>';
        
        try {
            const res = await fetch(`/api/insights/${id}/logs`);
            const data = await res.json();
            
            if (!data.logs || data.logs.length === 0) {
                content.innerHTML = '<div class="loading">暂无关联流水记录</div>';
                return;
            }

            let html = '<div style="display: flex; flex-direction: column; gap: 15px;">';
            data.logs.forEach(log => {
                const time = new Date(log.created_at).toLocaleString("zh-CN");
                const isError = log.status !== 'success' && log.status !== 'ok';
                const statusColor = isError ? "#e74c3c" : "#2ecc71";
                
                html += `
                <div style="border: 1px solid #444; border-radius: 8px; padding: 12px; background: rgba(255,255,255,0.02);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-weight: bold;">${log.provider} (${log.model})</span>
                        <span style="font-size: 0.8em; opacity: 0.7;">${time}</span>
                    </div>
                    <div style="margin-bottom: 8px;">
                        状态: <span style="color: ${statusColor}">${log.status}</span> | 耗时: ${log.duration_ms}ms
                    </div>
                    <details>
                        <summary style="cursor: pointer; opacity: 0.8; font-size: 0.9em;">解析详情 (JSON)</summary>
                        <div style="margin-top: 10px; font-size: 0.8em; background: #1a1a1a; padding: 8px; border-radius: 4px; overflow-x: auto;">
                            <strong>Prompt/Response:</strong>
                            <pre style="white-space: pre-wrap;">${JSON.stringify({req: log.request_json, resp: log.response_json}, null, 2)}</pre>
                            ${log.error_message ? `<div style="color: #e74c3c; margin-top: 8px;">错误: ${log.error_message}</div>` : ''}
                        </div>
                    </details>
                </div>`;
            });
            html += '</div>';
            content.innerHTML = html;
        } catch (e) {
            console.error(e);
            content.innerHTML = `<div class="error">加载流水日志失败</div>`;
        }
    }

    // 定时更新函数
    function createAutoUpdater(fetchFunction, interval = 60000) {
        return setInterval(fetchFunction, interval);
    }

    // 公共的定时更新函数
    function createDashboardAutoUpdater() {
        // 存储所有定时器的ID
        const timers = [];

        // 清除所有定时器
        function clearAllTimers() {
            timers.forEach((timerId) => clearInterval(timerId));
            timers.length = 0; // 清空数组
        }

        // 添加定时器到数组
        function addTimer(timerId) {
            timers.push(timerId);
        }

        // 返回公共接口
        return {
            clearAllTimers,
            addTimer,
        };
    }

    // 创建全局的定时更新器实例
    const dashboardUpdater = createDashboardAutoUpdater();

    // 初始化拖动功能
    function initDraggableCards() {
        // 最近播放和播放排行榜不再支持拖动
    }

    // 页面加载完成后初始化
    document.addEventListener("DOMContentLoaded", function () {
        // 自动切换日夜模式
        toggleDarkModeBasedOnSystem();

        // 监听系统主题变化
        watchSystemThemeChange();

        // 初始化各个组件
        initStats();
        initSourceChart(); // 初始化播放来源扇形图
        initTrendChart(30); // 默认加载30天数据
        initArtistChart("plays"); // 默认按播放次数排序
        initAlbumChart(30); // 默认加载30天数据
        initGenreChart(); // 初始化热门流派图表
        initRanking("all"); // 默认总排行
        initRecentPlays(); // 初始化最近播放列表

        // 连接到WebSocket服务器
        connectWebSocket();

        // 清除之前的定时器
        dashboardUpdater.clearAllTimers();

        // 设置定时器，每5秒刷新一次各个组件
        dashboardUpdater.addTimer(createAutoUpdater(initStats, 60000)); // 每60秒更新统计卡片
        dashboardUpdater.addTimer(createAutoUpdater(initSourceChart, 60000)); // 每60秒更新播放来源扇形图
        dashboardUpdater.addTimer(
            createAutoUpdater(
                () =>
                    initTrendChart(
                        document
                            .querySelector(".time-filter.active[data-range]")
                            .getAttribute("data-range") || 30
                    ),
                60000
            )
        ); // 每60秒更新趋势图
        dashboardUpdater.addTimer(
            createAutoUpdater(
                () =>
                    initArtistChart(
                        document
                            .querySelector(".time-filter.active[data-type]")
                            .getAttribute("data-type") || "plays"
                    ),
                60000
            )
        ); // 每60秒更新艺术家图表
        dashboardUpdater.addTimer(
            createAutoUpdater(
                () =>
                    initAlbumChart(
                        document
                            .querySelector(".time-filter.active[data-days]")
                            .getAttribute("data-days") || 30
                    ),
                60000
            )
        ); // 每60秒更新专辑图表
        dashboardUpdater.addTimer(createAutoUpdater(initGenreChart, 60000)); // 每60秒更新流派图表
        dashboardUpdater.addTimer(
            createAutoUpdater(
                () =>
                    initRanking(
                        document
                            .querySelector(".time-filter.active[data-ranking]")
                            .getAttribute("data-ranking") || "all"
                    ),
                60000
            )
        ); // 每60秒更新排行榜
        dashboardUpdater.addTimer(createAutoUpdater(refreshRecentPlays, 60000)); // 每60秒更新最近播放列表

        // 添加时间过滤器点击事件
        document.querySelectorAll(".time-filter").forEach((filter) => {
            // 跳过全屏按钮
            if (
                filter.id === "trendChartFullscreenBtn" ||
                filter.id === "genreChartFullscreenBtn"
            )
                return;

            filter.addEventListener("click", function () {
                // 移除同组其他过滤器的active类
                const parent = this.parentElement;
                parent.querySelectorAll(".time-filter").forEach((f) => {
                    // 跳过全屏按钮
                    if (
                        f.id === "trendChartFullscreenBtn" ||
                        f.id === "genreChartFullscreenBtn"
                    )
                        return;
                    f.classList.remove("active");
                });

                // 为当前过滤器添加active类
                this.classList.add("active");

                // 根据过滤器更新数据
                const filterType = parent.classList.contains("card-header")
                    ? parent.parentElement.querySelector(".card-title").textContent
                    : parent.closest(".chart-card")
                        ? parent.closest(".chart-card").querySelector(".card-title")
                            .textContent
                        : parent.closest(".ranking-card").querySelector(".card-title")
                            .textContent;

                if (filterType.includes("播放趋势")) {
                    // 更新趋势图
                    const range = this.getAttribute("data-range");
                    initTrendChart(range);
                } else if (filterType.includes("热门艺术家")) {
                    // 更新艺术家图表
                    const type = this.getAttribute("data-type");
                    initArtistChart(type);
                } else if (filterType.includes("热门专辑")) {
                    // 更新专辑图表
                    const days = this.getAttribute("data-days");
                    initAlbumChart(days);
                } else if (filterType.includes("播放排行榜")) {
                    // 更新排行榜
                    const ranking = this.getAttribute("data-ranking");
                    initRanking(ranking, rankingSearchKeyword);
                }
            });
        });

        // 全屏按钮点击事件
        document
            .getElementById("trendChartFullscreenBtn")
            .addEventListener("click", function () {
                toggleTrendChartFullscreen();
            });

        // 口味流派图表全屏按钮点击事件
        document
            .getElementById("genreChartFullscreenBtn")
            .addEventListener("click", function () {
                toggleGenreChartFullscreen();
            });

        // 页面加载完成后调整排行榜列表高度
        setTimeout(adjustRankingListsHeight, 1000);

        // 初始化拖动功能
        initDraggableCards();

        // 初始化正在播放悬浮窗的拖动功能
        initNowPlayingDrag();
        // 初始化 AI 歌词解析按钮
        initAiInsightButton();
        // 初始化歌词按钮和拖动功能
        initLyricsButton();
        initLyricsDrag();

        // 未上报标签页点击事件
        document
            .getElementById("unscrobbledTab")
            .addEventListener("click", function (e) {
                e.preventDefault();

                // 隐藏其他内容
                document.querySelector(".stats-container").style.display = "none";
                document.querySelector(".charts-container").style.display = "none";
                document.querySelector(".rankings-container").style.display =
                    "none";

                // 显示未上报容器
                document.getElementById("unscrobbledContainer").style.display =
                    "block";

                // 更新导航栏活动状态
                document.querySelectorAll(".nav-links a").forEach((link) => {
                    link.classList.remove("active");
                });
                this.classList.add("active");

                // 加载未上报记录
                currentUnscrobbledPage = 1;
                loadUnscrobbledRecords();
            });

        // 刷新按钮点击事件
        document
            .getElementById("refreshUnscrobbledBtn")
            .addEventListener("click", function () {
                loadUnscrobbledRecords();
            });

        // 同步选中按钮点击事件
        document
            .getElementById("syncSelectedBtn")
            .addEventListener("click", function () {
                syncSelectedRecords();
            });

        // 分页按钮事件
        document
            .getElementById("prevPage")
            .addEventListener("click", function () {
                if (currentUnscrobbledPage > 1) {
                    currentUnscrobbledPage--;
                    loadUnscrobbledRecords();
                }
            });

        document
            .getElementById("nextPage")
            .addEventListener("click", function () {
                const totalPages = Math.ceil(
                    totalUnscrobbledRecords / unscrobbledPageSize
                );
                if (currentUnscrobbledPage < totalPages) {
                    currentUnscrobbledPage++;
                    loadUnscrobbledRecords();
                }
            });

        // 点赞按钮点击事件
        document
            .getElementById("favoriteButton")
            .addEventListener("click", handleFavoriteButtonClick);

        // 音眸列表标签页点击事件
        document.getElementById("insightListTab").addEventListener("click", function (e) {
            e.preventDefault();
            document.querySelector(".stats-container").style.display = "none";
            document.querySelector(".charts-container").style.display = "none";
            document.querySelector(".rankings-container").style.display = "none";
            document.getElementById("unscrobbledContainer").style.display = "none";
            document.getElementById("insightListContainer").style.display = "block";

            document.querySelectorAll(".nav-links a").forEach((link) => link.classList.remove("active"));
            this.classList.add("active");

            currentInsightPage = 1;
            loadInsightList();
        });

        // 音眸列表相关事件
        const refreshBtn = document.getElementById("refreshInsightListBtn");
        if (refreshBtn) {
            refreshBtn.addEventListener("click", () => {
                currentInsightPage = 1;
                loadInsightList();
            });
        }

        const searchInput = document.getElementById("insightSearchInput");
        if (searchInput) {
            searchInput.addEventListener("input", (e) => {
                const val = e.target.value.trim();
                if (insightSearchTimeout) clearTimeout(insightSearchTimeout);
                
                insightSearchTimeout = setTimeout(() => {
                    currentInsightKeyword = val;
                    currentInsightPage = 1;
                    loadInsightList();
                }, 500);
            });
        }

        // 播放排行榜搜索
        const rankingSearchInput = document.getElementById("rankingSearchInput");
        if (rankingSearchInput) {
            rankingSearchInput.addEventListener("input", (e) => {
                const val = e.target.value.trim();
                if (rankingSearchTimeout) clearTimeout(rankingSearchTimeout);
                
                rankingSearchTimeout = setTimeout(() => {
                    initRanking(currentRankingType, val);
                }, 500);
            });
        }
        document.getElementById("insightPrevPage").addEventListener("click", () => {
            if (currentInsightPage > 1) {
                currentInsightPage--;
                loadInsightList();
            }
        });
        document.getElementById("insightNextPage").addEventListener("click", () => {
            const totalPages = Math.ceil(totalInsights / insightPageSize);
            if (currentInsightPage < totalPages) {
                currentInsightPage++;
                loadInsightList();
            }
        });
        document.getElementById("closeCallLogModal").addEventListener("click", () => hideModal("callLogModal"));
    });

    // 添加查看详情模态框相关函数
    // 显示模态框
    function showModal(modalId) {
        document.getElementById(modalId).style.display = "block";
    }

    // 隐藏模态框
    function hideModal(modalId) {
        document.getElementById(modalId).style.display = "none";
        
        // 增加清理逻辑
        if (modalId === 'nowPlayingInsightModal' || modalId === 'listInsightModal') {
            const contextType = modalId === 'nowPlayingInsightModal' ? 'nowPlaying' : 'list';
            const state = insightStates[contextType];
            
            // 1. 关闭 SSE
            if (state.eventSource) {
                state.eventSource.close();
                state.eventSource = null;
            }
            
            // 2. 清空 DOM
            const streamContent = document.getElementById(`${contextType}-aiInsightStreamContent`);
            if (streamContent) {
                streamContent.innerHTML = '<div class="loading">准备中...</div>';
            }
            
            // 3. 重置状态 (除 trackInfo 外)
            state.insight = null;
            state.allInsights = [];
            
            // 如果两个主要的都没了，兼容性的 currentTrackInsight 也可以清了
            if (!insightStates.nowPlaying.insight && !insightStates.list.insight) {
                currentTrackInsight = null;
            }

            // 切换回第一个 Tab (UI)
            switchInsightTab('summary', contextType);
        }
    }

    // 获取并显示曲目详细信息
    async function showTrackDetails(artist, album, trackName) {
        // 1. 彻底清空旧数据，防止数据污染
        window.currentDetailData = {
            track: null,
            insight: null,
            loadingTrack: true,
            loadingInsight: true
        };

        const modal = document.getElementById("trackDetailsModal");
        const modalContent = modal.querySelector(".modal-content");

        // 2. 初始化骨架结构
        modalContent.innerHTML = `
          <div class="module-trail"></div>
          <div class="modal-header">
            <h2 id="detailTrackTitle">${trackName}</h2>
            <span class="close" onclick="hideModal('trackDetailsModal')">×</span>
          </div>
          <div class="modal-tabs">
            <div class="modal-tab active" onclick="switchDetailTab('basic')"><span>📊</span> 基础信息</div>
            <div class="modal-tab" onclick="switchDetailTab('lyrics')"><span>📜</span> 歌曲歌词</div>
            <div class="modal-tab" onclick="switchDetailTab('ai')"><span>🤖</span> 音眸</div>
          </div>
          <div class="modal-body" id="detailModalBody">
            <div class="loading">正在加载曲目基础信息...</div>
          </div>
        `;

        showModal("trackDetailsModal");

        // 3. 异步获取基础详情 (不阻塞)
        fetch(`/api/track?artist=${encodeURIComponent(artist)}&album=${encodeURIComponent(album)}&trackName=${encodeURIComponent(trackName)}`)
            .then(r => r.ok ? r.json() : null)
            .then(data => {
                window.currentDetailData.track = data;
                window.currentDetailData.loadingTrack = false;
                // 只有当用户还在基础信息 Tab 时才自动渲染
                const activeTab = document.querySelector("#trackDetailsModal .modal-tab.active");
                if (activeTab && activeTab.innerText.includes("基础信息")) {
                    renderTrackDetailsContent('basic');
                }
            })
            .catch(e => {
                console.error("加载基础信息失败:", e);
                window.currentDetailData.loadingTrack = false;
            });

        // 4. 异步获取已有的 AI Insight (仅查询 GET)
        const insightUrl = `/api/track-insight?artist=${encodeURIComponent(artist)}&album=${encodeURIComponent(album)}&track=${encodeURIComponent(trackName)}`;
        fetch(insightUrl)
            .then(r => r.ok ? r.json() : null)

            .then(data => {
                // 兼容多种返回格式
                let insights = [];
                if (data) {
                    if (data.insights) insights = data.insights;
                    else if (data.insight) insights = [data.insight];
                    else if (Array.isArray(data)) insights = data;
                }
                window.currentDetailData.insights = insights;
                window.currentDetailData.loadingInsight = false;
                // 如果用户这时已经切换到了 AI Tab，则在加载完后刷新渲染
                const activeTab = document.querySelector("#trackDetailsModal .modal-tab.active");
                if (activeTab && activeTab.innerText.includes("AI 分析")) {
                    renderTrackDetailsContent('ai');
                }
            })
            .catch(e => {
                console.error("查询 AI 历史记录失败:", e);
                window.currentDetailData.loadingInsight = false;
            });
    }

    // Tab 切换逻辑
    function switchDetailTab(tabName) {
        const tabs = document.querySelectorAll("#trackDetailsModal .modal-tab");
        tabs.forEach(t => t.classList.remove("active"));

        if (tabName === 'basic') tabs[0].classList.add("active");
        else if (tabName === 'lyrics') tabs[1].classList.add("active");
        else tabs[2].classList.add("active");

        renderTrackDetailsContent(tabName);
    }

    // 渲染曲目详情具体内容
    function renderTrackDetailsContent(tabName) {
        const bodyContent = document.getElementById("detailModalBody");
        const data = window.currentDetailData;

        if (tabName === 'basic') {
            if (data.loadingTrack) {
                bodyContent.innerHTML = '<div class="loading">正在加载基础信息...</div>';
                return;
            }
            if (!data.track) {
                bodyContent.innerHTML = '<div class="error">未找到曲目基础信息</div>';
                return;
            }
            const track = data.track;
            const formatDuration = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, "0")}`;
            };

            let sourceClass = "";
            let sourceText = "";
            switch (track.source?.toLowerCase()) {
                case "apple music":
                    sourceClass = "source-applemusic";
                    sourceText = "AppleMusic";
                    break;
                case "audirvana":
                case "au":
                    sourceClass = "source-audirvana";
                    sourceText = "Audirvana";
                    break;
                case "roon":
                    sourceClass = "source-roon";
                    sourceText = "Roon";
                    break;
                default:
                    sourceClass = "";
                    sourceText = track.source || "Unknown";
            }

            bodyContent.innerHTML = `
            <div class="track-info">
              <p><strong>艺术家:</strong> ${track.artist}</p>
              <p><strong>专辑:</strong> ${track.album}</p>
              <p><strong>播放次数:</strong> ${track.play_count || 0}</p>
              ${track.duration ? `<p><strong>时长:</strong> ${formatDuration(track.duration)}</p>` : ''}
              ${track.track_number ? `<p><strong>曲目编号:</strong> ${track.track_number}</p>` : ''}
              ${track.genre ? `<p><strong>流派:</strong> ${track.genre}</p>` : ''}
              <p><strong>喜欢苹果音乐:</strong> ${track.is_apple_music_fav ? "是" : "否"}</p>
              <p><strong>喜欢Last.fm:</strong> ${track.is_last_fm_fav ? "是" : "否"}</p>
              <p><strong>数据来源:</strong> <span class="play-source ${sourceClass}">${sourceText}</span></p>
              <p><strong>更新时间:</strong> ${new Date(track.updated_at).toLocaleString('zh-CN')}</p>
            </div>
          `;
        } else if (tabName === 'lyrics') {
            // 歌词 Tab
            const track = data.track;
            if (!track) {
                bodyContent.innerHTML = '<div class="loading">正在加载数据...</div>';
                return;
            }

            bodyContent.innerHTML = '<div class="loading">正在查询歌词...</div>';

            fetch(`/api/track-lyrics?artist=${encodeURIComponent(track.artist)}&album=${encodeURIComponent(track.album || '')}&track=${encodeURIComponent(track.track)}`)
                .then(r => r.json())
                .then(lyricsData => {
                    if (lyricsData.lyrics) {
                        bodyContent.innerHTML = `
                  <div class="lyrics-container" style="padding: 20px; font-family: sans-serif; line-height: 1.8; text-align: center;">
                    <div class="lyrics-text" style="white-space: pre-wrap;">${lyricsData.lyrics}</div>
                  </div>
                `;
                    } else {
                        bodyContent.innerHTML = `
                  <div style="text-align: center; padding: 40px 20px;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">🎶</div>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">本地暂无该曲目的歌词数据</p>
                    <button class="action-btn" onclick="triggerLyricsSearch()" style="background: var(--primary-color); color: white; padding: 10px 25px; border-radius: 20px; font-weight: 600;">🔍 立即在线查询</button>
                    <div id="lyricSearchStatus" style="margin-top: 15px; font-size: 0.9rem; color: var(--primary-color);"></div>
                  </div>
                `;
                    }
                })
                .catch(err => {
                    bodyContent.innerHTML = `<div class="error">查询失败: ${err.message}</div>`;
                });

        } else {
            // AI Tab
            if (data.loadingInsight) {
                bodyContent.innerHTML = '<div class="loading">正在查询 AI 解析历史...</div>';
                return;
            }

            const insights = data.insights || [];

            if (insights.length === 0) {
                bodyContent.innerHTML = `
              <div style="text-align: center; padding: 40px 20px;">
                <div style="font-size: 3rem; margin-bottom: 20px;">🔍</div>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">暂无该曲目的 AI 深度分析</p>
                <div style="display: flex; justify-content: center; gap: 10px;">
                   <button class="action-btn" onclick="hideModal('trackDetailsModal'); showModelPicker({artist: window.currentDetailData.track.artist, album: window.currentDetailData.track.album, title: window.currentDetailData.track.track}, 'details');" style="background: var(--primary-color); color: white; padding: 10px 25px; border-radius: 20px; font-weight: 600;">✨ 开始分析</button>
                </div>
              </div>
            `;
                return;
            }

            let html = '';

            // 如果有多个结果，显示 Tab
            if (insights.length > 1) {
                const positiveTotal = insights.reduce((sum, i) => sum + Math.max(0, i.total_score || 0), 0);
                html += '<div class="insight-tabs">';
                insights.forEach((insight, index) => {
                    const date = new Date(insight.created_at || Date.now());
                    const timeStr = date.toLocaleString('zh-CN', {
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    const activeClass = index === 0 ? 'active' : '';
                    const totalScore = insight.total_score || 0;
                    let supportRate;
                    if (positiveTotal > 0) {
                        supportRate = ((totalScore / positiveTotal) * 100).toFixed(1);
                    } else {
                        supportRate = totalScore === 0 ? '0.0' : (totalScore > 0 ? '100.0' : '-100.0');
                    }
                    html += `<div class="insight-tab ${activeClass}" onclick="switchDetailInsightTab(${index})" title="总分: ${totalScore} | 支持率: ${supportRate}%">分析 ${insights.length - index} <small>(${timeStr})</small></div>`;
                });
                html += '</div>';
            }

            html += '<div id="detail-insight-content-container">';
            insights.forEach((insight, index) => {
                const displayStyle = index === 0 ? 'block' : 'none';
                html += `<div class="insight-item" id="detail-insight-item-${index}" style="display: ${displayStyle};">`;
                html += generateInsightContentHtml(insight);
                // 添加一致的操作按钮行
                html += `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color); gap: 15px;">
                  <button class="action-btn" style="flex: 1; padding: 8px 15px; border-radius: 20px; font-weight: 600;" onclick="hideModal('trackDetailsModal'); showModelPicker({artist: window.currentDetailData.track.artist, album: window.currentDetailData.track.album, title: window.currentDetailData.track.track}, 'details');">🔄 重新分析</button>
                  <button class="action-btn" style="flex: 1; padding: 8px 15px; border-radius: 20px; font-weight: 600; background: rgba(52, 152, 219, 0.1); color: var(--primary-color); border-color: var(--primary-color);" onclick="shareDetailInsight(${index})">分享图片</button>
                  <div style="display: flex; gap: 10px; flex: 1; justify-content: flex-end;">
                    <button class="action-btn" style="padding: 6px 12px; border-radius: 15px; background: rgba(46, 204, 113, 0.1); color: var(--secondary-color); border-color: var(--secondary-color);" onclick="recordAiFeedback(1)">👍 赞</button>
                    <button class="action-btn" style="padding: 6px 12px; border-radius: 15px; background: rgba(231, 76, 60, 0.1); color: var(--accent-color); border-color: var(--accent-color);" onclick="recordAiFeedback(-1)">👎 踩</button>
                  </div>
                </div>
              `;
                html += '</div>';
            });
            html += '</div>';

            bodyContent.innerHTML = html;
            // 保存 insights 到全局变量，以便切换 tab 和点赞点踩使用
            window.currentDetailData.insights = insights;
            // 更新选中的 ID，以便全局 feedback 可用
            currentTrackInsight = insights[0];
        }
    }

    async function triggerLyricsSearch() {
        const track = window.currentDetailData.track;
        if (!track) return;

        const statusEl = document.getElementById("lyricSearchStatus");
        statusEl.textContent = "正在通过网络搜索歌词，请稍候...";

        try {
            // 假设后端接口支持 force 参数来触发刷新，或者通过这个接口本身就能完成搜索并保存
            // 这里调用的是相同的接口，但由于之前查询结果为空，点击此按钮通常由于用户想手动触发搜索
            const resp = await fetch(`/api/track-lyrics?artist=${encodeURIComponent(track.artist)}&album=${encodeURIComponent(track.album || '')}&track=${encodeURIComponent(track.track)}&force=true`);
            const data = await resp.json();

            if (data.lyrics) {
                statusEl.textContent = "找到歌词！正在刷新...";
                setTimeout(() => switchDetailTab('lyrics'), 1000);
            } else {
                statusEl.textContent = "抱歉，依然未找到歌词。";
            }
        } catch (e) {
            statusEl.textContent = "查询出错: " + e.message;
        }
    }

    function switchDetailInsightTab(index) {
        console.log("switchDetailInsightTab:", index);
        const container = document.getElementById("detailModalBody");
        container.querySelectorAll('.insight-tab').forEach((tab, i) => {
            if (i === index) tab.classList.add('active');
            else tab.classList.remove('active');
        });
        container.querySelectorAll('.insight-item').forEach((item, i) => {
            if (i === index) item.style.display = 'block';
            else item.style.display = 'none';
        });
        // 更新当前选中的 insight，以便点赞点踩使用正确的 ID
        if (window.currentDetailData && window.currentDetailData.insights && window.currentDetailData.insights[index]) {
            currentTrackInsight = window.currentDetailData.insights[index];
            console.log("Detail currentTrackInsight updated to index", index, ":", currentTrackInsight);
        }
    }

</script>

<!-- 曲目详情模态框 -->
<div id="trackDetailsModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="module-trail"></div>
        <!-- 内容由 JavaScript 动态生成，包含 Tab 结构 -->
    </div>
</div>

<!-- “正在播放” AI 歌词解析模态框 -->
<div id="nowPlayingInsightModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="module-trail"></div>
        <div class="modal-header">
            <h2>音眸 (正在播放)</h2>
            <span class="close" onclick="hideModal('nowPlayingInsightModal')">×</span>
        </div>
        <div class="modal-body">
            <!-- 页签导航 -->
            <div class="insight-tabs">
                <div class="insight-tab active" onclick="switchInsightTab('summary', 'nowPlaying')">解析详情</div>
                <div class="insight-tab" onclick="switchInsightTab('feedback', 'nowPlaying')">用户反馈</div>
                <div class="insight-tab" onclick="switchInsightTab('raw', 'nowPlaying')">原始数据</div>
            </div>

            <!-- 解析详情页签 -->
            <div id="nowPlaying-insightSummaryTab" class="insight-tab-content">
                <div id="nowPlaying-aiInsightStreamContent"
                     style="white-space: pre-wrap; font-family: 'Segoe UI', system-ui, sans-serif; max-height: 60vh; overflow-y: auto; padding: 20px; background: var(--background-color); border-radius: 12px; border: 1px solid var(--border-color); box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);">
                    <div class="loading">准备中...</div>
                </div>
            </div>

            <!-- 用户反馈页签 -->
            <div id="nowPlaying-insightFeedbackTab" class="insight-tab-content" style="display: none;">
                <div id="nowPlaying-insightFeedbackContent" style="max-height: 60vh; overflow-y: auto; padding: 10px;">
                    <div class="loading">加载中...</div>
                </div>
            </div>

            <!-- 原始数据页签 -->
            <div id="nowPlaying-insightRawTab" class="insight-tab-content" style="display: none;">
                <div id="nowPlaying-insightRawContent" style="max-height: 60vh; overflow-y: auto; padding: 20px; background: var(--background-color); border-radius: 12px; border: 1px solid var(--border-color);">
                    <pre style="white-space: pre-wrap; font-size: 0.85em; color: var(--accent-color);"></pre>
                </div>
            </div>

            <!-- 底部操作区 -->
            <div id="nowPlaying-aiActionFooter"
                 style="margin-top: 15px; padding: 10px 0; border-top: 1px solid var(--border-color); display: none; justify-content: space-between; align-items: center; gap: 20px;">
                <button id="nowPlaying-aiReanalyzeBtn" class="action-btn"
                        style="flex: 1; padding: 8px 15px; border-radius: 20px; font-weight: 600;"
                        onclick="showModelPicker(null, 'nowPlaying')">重新分析
                </button>
                <button id="nowPlaying-aiShareBtn" class="action-btn"
                        style="flex: 1; padding: 8px 15px; border-radius: 20px; font-weight: 600; background: rgba(52, 152, 219, 0.1); color: var(--primary-color); border-color: var(--primary-color);"
                        onclick="shareInsight('nowPlaying')">分享图片
                </button>
                <div id="nowPlaying-aiFeedbackBtns" style="display: flex; gap: 10px; flex: 1; justify-content: flex-end;">
                    <button class="action-btn"
                            style="padding: 6px 12px; border-radius: 15px; background: rgba(46, 204, 113, 0.1); color: var(--secondary-color); border-color: var(--secondary-color);"
                            onclick="recordAiFeedback(1, 'nowPlaying')">👍 赞
                    </button>
                    <button class="action-btn"
                            style="padding: 6px 12px; border-radius: 15px; background: rgba(231, 76, 60, 0.1); color: var(--accent-color); border-color: var(--accent-color);"
                            onclick="recordAiFeedback(-1, 'nowPlaying')">👎 踩
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- “音眸列表” AI 歌词解析模态框 -->
<div id="listInsightModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="module-trail"></div>
        <div class="modal-header">
            <h2>音眸 (分析历史)</h2>
            <span class="close" onclick="hideModal('listInsightModal')">×</span>
        </div>
        <div class="modal-body">
            <!-- 页签导航 -->
            <div class="insight-tabs">
                <div class="insight-tab active" onclick="switchInsightTab('summary', 'list')">解析详情</div>
                <div class="insight-tab" onclick="switchInsightTab('feedback', 'list')">用户反馈</div>
                <div class="insight-tab" onclick="switchInsightTab('raw', 'list')">原始数据</div>
            </div>

            <!-- 解析详情页签 -->
            <div id="list-insightSummaryTab" class="insight-tab-content">
                <div id="list-aiInsightStreamContent"
                     style="white-space: pre-wrap; font-family: 'Segoe UI', system-ui, sans-serif; max-height: 60vh; overflow-y: auto; padding: 20px; background: var(--background-color); border-radius: 12px; border: 1px solid var(--border-color); box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);">
                    <div class="loading">准备中...</div>
                </div>
            </div>

            <!-- 用户反馈页签 -->
            <div id="list-insightFeedbackTab" class="insight-tab-content" style="display: none;">
                <div id="list-insightFeedbackContent" style="max-height: 60vh; overflow-y: auto; padding: 10px;">
                    <div class="loading">加载中...</div>
                </div>
            </div>

            <!-- 原始数据页签 -->
            <div id="list-insightRawTab" class="insight-tab-content" style="display: none;">
                <div id="list-insightRawContent" style="max-height: 60vh; overflow-y: auto; padding: 20px; background: var(--background-color); border-radius: 12px; border: 1px solid var(--border-color);">
                    <pre style="white-space: pre-wrap; font-size: 0.85em; color: var(--accent-color);"></pre>
                </div>
            </div>

            <!-- 底部操作区 -->
            <div id="list-aiActionFooter"
                 style="margin-top: 15px; padding: 10px 0; border-top: 1px solid var(--border-color); display: none; justify-content: space-between; align-items: center; gap: 20px;">
                <button id="list-aiReanalyzeBtn" class="action-btn"
                        style="flex: 1; padding: 8px 15px; border-radius: 20px; font-weight: 600;"
                        onclick="showModelPicker(null, 'list')">重新分析
                </button>
                <button id="list-aiShareBtn" class="action-btn"
                        style="flex: 1; padding: 8px 15px; border-radius: 20px; font-weight: 600; background: rgba(52, 152, 219, 0.1); color: var(--primary-color); border-color: var(--primary-color);"
                        onclick="shareInsight('list')">分享图片
                </button>
                <div id="list-aiFeedbackBtns" style="display: flex; gap: 10px; flex: 1; justify-content: flex-end;">
                    <button class="action-btn"
                            style="padding: 6px 12px; border-radius: 15px; background: rgba(46, 204, 113, 0.1); color: var(--secondary-color); border-color: var(--secondary-color);"
                            onclick="recordAiFeedback(1, 'list')">👍 赞
                    </button>
                    <button class="action-btn"
                            style="padding: 6px 12px; border-radius: 15px; background: rgba(231, 76, 60, 0.1); color: var(--accent-color); border-color: var(--accent-color);"
                            onclick="recordAiFeedback(-1, 'list')">👎 踩
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- “歌曲详情” AI 歌词解析模态框 -->
<div id="detailsInsightModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="module-trail"></div>
        <div class="modal-header">
            <h2>音眸 (歌曲详情)</h2>
            <span class="close" onclick="hideModal('detailsInsightModal')">×</span>
        </div>
        <div class="modal-body">
            <!-- 页签导航 -->
            <div class="insight-tabs">
                <div class="insight-tab active" onclick="switchInsightTab('summary', 'details')">解析详情</div>
                <div class="insight-tab" onclick="switchInsightTab('feedback', 'details')">用户反馈</div>
                <div class="insight-tab" onclick="switchInsightTab('raw', 'details')">原始数据</div>
            </div>

            <!-- 解析详情页签 -->
            <div id="details-insightSummaryTab" class="insight-tab-content">
                <div id="details-aiInsightStreamContent"
                     style="white-space: pre-wrap; font-family: 'Segoe UI', system-ui, sans-serif; max-height: 60vh; overflow-y: auto; padding: 20px; background: var(--background-color); border-radius: 12px; border: 1px solid var(--border-color); box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);">
                    <div class="loading">准备中...</div>
                </div>
            </div>

            <!-- 用户反馈页签 -->
            <div id="details-insightFeedbackTab" class="insight-tab-content" style="display: none;">
                <div id="details-insightFeedbackContent" style="max-height: 60vh; overflow-y: auto; padding: 10px;">
                    <div class="loading">加载中...</div>
                </div>
            </div>

            <!-- 原始数据页签 -->
            <div id="details-insightRawTab" class="insight-tab-content" style="display: none;">
                <div id="details-insightRawContent" style="max-height: 60vh; overflow-y: auto; padding: 20px; background: var(--background-color); border-radius: 12px; border: 1px solid var(--border-color);">
                    <pre style="white-space: pre-wrap; font-size: 0.85em; color: var(--accent-color);"></pre>
                </div>
            </div>

            <!-- 底部操作区 -->
            <div id="details-aiActionFooter"
                 style="margin-top: 15px; padding: 10px 0; border-top: 1px solid var(--border-color); display: none; justify-content: space-between; align-items: center; gap: 20px;">
                <button id="details-aiReanalyzeBtn" class="action-btn"
                        style="flex: 1; padding: 8px 15px; border-radius: 20px; font-weight: 600;"
                        onclick="showModelPicker(null, 'details')">重新分析
                </button>
                <button id="details-aiShareBtn" class="action-btn"
                        style="flex: 1; padding: 8px 15px; border-radius: 20px; font-weight: 600; background: rgba(52, 152, 219, 0.1); color: var(--primary-color); border-color: var(--primary-color);"
                        onclick="shareInsight('details')">分享图片
                </button>
                <div id="details-aiFeedbackBtns" style="display: flex; gap: 10px; flex: 1; justify-content: flex-end;">
                    <button class="action-btn"
                            style="padding: 6px 12px; border-radius: 15px; background: rgba(46, 204, 113, 0.1); color: var(--secondary-color); border-color: var(--secondary-color);"
                            onclick="recordAiFeedback(1, 'details')">👍 赞
                    </button>
                    <button class="action-btn"
                            style="padding: 6px 12px; border-radius: 15px; background: rgba(231, 76, 60, 0.1); color: var(--accent-color); border-color: var(--accent-color);"
                            onclick="recordAiFeedback(-1, 'details')">👎 踩
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AI 模型选择模态框 -->
<div id="aiModelPickerModal" class="modal" style="z-index: 2100;">
    <div class="modal-content" style="max-width: 400px; padding: 25px;">
        <div class="module-trail"></div>
        <div class="modal-header" style="margin-bottom: 20px;">
            <h3>选择 AI 分析模型</h3>
            <span class="close" onclick="hideModal('aiModelPickerModal')">×</span>
        </div>
        <div class="ai-model-selector" style="margin-bottom: 20px;">
            <label for="aiModelSelect">当前可用模型:</label>
            <select id="aiModelSelect"
                    style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--card-bg); color: var(--text-primary); margin-bottom: 15px;">
                <option value="ollama">Ollama (本地)</option>
            </select>
            <div style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="aiModelSseToggle" checked style="width: auto;">
                <label for="aiModelSseToggle" style="font-weight: normal; cursor: pointer;">流式输出结果</label>
            </div>
        </div>
        <div style="display: flex; gap: 12px;">
            <button class="action-btn"
                    style="flex: 1; padding: 10px; background: var(--primary-color); color: white; border-radius: 6px;"
                    onclick="startAnalysisWithSelectedModel()">开始分析
            </button>
            <button class="action-btn"
                    style="flex: 1; padding: 10px; background: var(--text-secondary); color: white; border-radius: 6px;"
                    onclick="hideModal('aiModelPickerModal')">取消
            </button>
        </div>
    </div>
</div>

<!-- 分享图片容器 (隐藏，用于生成图片) -->
<div id="shareInsightContainer"
     style="position: absolute; left: -9999px; top: -9999px; width: 393px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-family: 'Segoe UI', system-ui, sans-serif; color: #fff; overflow: visible;">
    <div style="padding: 24px 20px;">
        <div style="text-align: center; margin-bottom: 24px;">
            <div style="font-size: 10px; letter-spacing: 2px; text-transform: uppercase; opacity: 0.8; margin-bottom: 10px;">
                AI Lyrics Insight
            </div>
            <h1 id="shareTrackTitle"
                style="font-size: 20px; font-weight: 700; margin: 0 0 8px 0; line-height: 1.3;"></h1>
            <p id="shareTrackMeta" style="font-size: 13px; opacity: 0.9; margin: 0;"></p>
        </div>
        <div id="shareInsightContent"
             style="background: rgba(255,255,255,0.12); border-radius: 12px; padding: 16px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);"></div>
        <div style="margin-top: 20px; text-align: center; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.2);">
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px; color: #fff;margin-bottom:3px;">
                <!-- 内联图标：同心圆 -->
                <svg width="32" height="32" viewBox="0 0 70 70" xmlns="http://www.w3.org/2000/svg"
                     style="flex-shrink: 0; opacity: 0.9;">
                    <g transform="translate(35, 35)">
                        <circle cx="0" cy="0" r="28" fill="none" stroke="white" stroke-width="3"
                                stroke-dasharray="175 5"/>
                        <circle cx="0" cy="0" r="20" fill="none" stroke="white" stroke-width="3"
                                stroke-dasharray="125 5"/>
                        <circle cx="0" cy="0" r="12" fill="none" stroke="white" stroke-width="3"
                                stroke-dasharray="75 5"/>
                        <circle cx="0" cy="0" r="4" fill="white"/>
                    </g>
                </svg>
                <!-- HTML 文本：品牌信息 -->
                <div style="text-align: left; display: flex; flex-direction: column; gap: 2px;">
                    <div style="font-size: 13px; font-weight: 700; opacity: 0.95; letter-spacing: 0.5px; white-space: nowrap;">
                        音眸轨迹 · SonicLens
                    </div>
                    <div style="font-size: 8px; opacity: 0.7; letter-spacing: 0.2px; white-space: nowrap;">声之透镜 ·
                        深度解析 · 聆听之印记
                    </div>
                </div>
            </div>
            <div style="font-size: 10px; opacity: 0.7;">
                <span>@vincentchyu</span> ·
                <span id="shareModelName">AI</span>
            </div>
            <div style="font-size: 9px; opacity: 0.5; margin-top: 3px;">blog-vincent.chyu.org</div>
        </div>
    </div>
</div>

<!-- Watermark Logo -->
<div class="watermark"></div>

<script>
    // 侧边栏切换逻辑
    document.addEventListener('DOMContentLoaded', () => {
        const navbar = document.getElementById('mainNavbar');
        const toggleBtn = document.getElementById('navToggle');
        
        // 从 localStorage 加载用户偏好
        const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
        if (isCollapsed && window.innerWidth > 1200) {
            navbar.classList.add('collapsed');
            toggleBtn.textContent = '▶';
        }

        toggleBtn.addEventListener('click', () => {
            const currentlyCollapsed = navbar.classList.toggle('collapsed');
            toggleBtn.textContent = currentlyCollapsed ? '▶' : '◀';
            localStorage.setItem('sidebarCollapsed', currentlyCollapsed);
        });
    });
</script>
</body>
</html>
